
# Исправление статистики клуба, бейджей доступа и администраторов

## Выявленные проблемы

### 1. Бейдж "Без доступа" у Ирины Гариновой (и других)
Бейдж статуса доступа использует поле `access_status` из таблицы `telegram_club_members` -- это **кэшированное** значение, которое может устаревать. При этом фильтрация по вкладке "С доступом" корректно использует **вычисляемое** поле `has_active_access` (через EXISTS по 3 таблицам).

У Ирины Гариновой в БД: `access_status = 'no_access'`, но при этом есть 3 активных гранта в `telegram_access_grants`. Поэтому она корректно попадает в "С доступом", но бейдж показывает красный "Без доступа".

**Решение:** В функции `getAccessStatusBadge` и в подсветке строки таблицы использовать `has_active_access` как приоритетный источник, а `access_status` -- как fallback.

### 2. Статистика "Новые 44" при 35 с доступом
Клуб создан 6 февраля (17 дней назад). RPC `get_club_business_stats` считает "новых" как пользователей, чей ПЕРВЫЙ EVER грант создан за период. Всего уникальных пользователей = 44, и все первые гранты -- за последние 30 дней. Поэтому "Новые = 44", хотя активных только 35. Технически верно, но вводит в заблуждение.

**Решение:** Добавить в карточку "Новые" уточняющий субтитл "получили первый доступ" вместо "впервые вступили", и добавить тултип с объяснением, что это учитывает всех, включая ушедших.

### 3. Статистические карточки занимают слишком много места
Два ряда по 4 стеклянных карточки + блок админов = половина экрана.

**Решение:** Сделать карточки компактнее: уменьшить высоту с 108px до 80px, уменьшить padding, шрифты. Убрать переключатель периода (7/30/90 дн.) из основного блока -- он не влияет на тарифы.

### 4. Администраторы -- отдельная вкладка
Сейчас администраторы показаны внутри стеклянного блока статистики. Пользователь хочет видеть их как отдельную вкладку рядом с "В клубе", "С доступом" и т.д.

**Решение:** Добавить 6-ю вкладку "Админы" в TabsList с количеством (включая ботов). При выборе этой вкладки в таблице показывать только администраторов (по данным из `useClubAdmins`).

---

## Технический план

### Файл: `src/pages/admin/TelegramClubMembers.tsx`

1. **Импортировать `useClubAdmins`** и вызвать хук с `clubId`
2. **Добавить тип `'admins'` в `FilterTab`** 
3. **Добавить вкладку "Админы"** в TabsList (6-я вкладка) с Badge-счетчиком
4. **Добавить фильтрацию** для вкладки `admins`: показывать только тех `members`, чей `telegram_user_id` есть в `adminsList`
5. **Исправить `getAccessStatusBadge`**: принимать `has_active_access` и показывать "С доступом" если `has_active_access === true`, независимо от `access_status`
6. **Исправить подсветку строки**: использовать `has_active_access` вместо `access_status` для определения стиля строки

### Файл: `src/components/telegram/ClubQuickStats.tsx`

7. **Уменьшить карточки**: высота 80px вместо 108px, меньше padding
8. **Убрать блок "Администраторы клуба"** из нижней части статистики (переносится в отдельную вкладку)
9. **Уточнить субтитл "Новые"**: "получили первый доступ" вместо "впервые вступили"

## НЕ трогаем

- RPC `get_club_business_stats` -- данные корректны, меняем только подписи
- RPC `get_club_members_enriched` -- вычисления верны
- Хук `useClubAdmins` -- работает корректно
- View `v_club_members_enriched` -- логика has_active_access верна
- Остальные компоненты и страницы

## Затронутые файлы

| Файл | Изменения |
|---|---|
| `src/pages/admin/TelegramClubMembers.tsx` | Вкладка "Админы", исправление бейджа доступа, фильтрация по админам |
| `src/components/telegram/ClubQuickStats.tsx` | Компактные карточки, убрать блок админов, уточнить подписи |

## DoD

1. Бейдж "Статус доступа" использует `has_active_access` как приоритет -- Ирина Гаринова показывается "С доступом"
2. Вкладка "Админы (4)" отображает всех администраторов включая ботов
3. Статистические карточки занимают меньше места (компактнее на 30%)
4. Подписи карточек соответствуют логике расчета
5. Нет ошибок сборки/TS
