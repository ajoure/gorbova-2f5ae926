
# ะะปะฐะฝ: ะะฐััะพะฒะพะต ัะพะทะดะฐะฝะธะต ัะดะตะปะพะบ ะธะท ะฟะปะฐัะตะถะตะน + ะัะฟัะฐะฒะปะตะฝะธะต ะฟะพะปััะตะฝะธั ัะตะบะพะฒ

## ะะฑะทะพั ะทะฐะดะฐัะธ

ะะพะปัะทะพะฒะฐัะตะปั ะทะฐะฟัะฐัะธะฒะฐะตั ะดะฒะต ััะฝะบัะธะธ:

1. **ะะฒัะพัะพะทะดะฐะฝะธะต ัะดะตะปะพะบ** โ ะบะฝะพะฟะบะฐ ะดะปั ะผะฐััะพะฒะพะณะพ ัะพะทะดะฐะฝะธั ัะดะตะปะพะบ ะธะท ะฒัะฑัะฐะฝะฝัั ะฟะปะฐัะตะถะตะน ั:
   - ะัะฑะพัะพะผ ะฟัะพะดัะบัะฐ ะธ ัะฐัะธัะฐ (ะตะดะธะฝัะต ะดะปั ะฒัะตั ัะพะทะดะฐะฒะฐะตะผัั ัะดะตะปะพะบ)
   - ะะฒัะพะผะฐัะธัะตัะบะพะน ะฝัะผะตัะฐัะธะตะน ัะดะตะปะพะบ ะฟะพ ะฟะพััะดะบั ะฟะพะบัะฟะบะธ ะบะฐะถะดะพะณะพ ะบะพะฝัะฐะบัะฐ
   - ะะฐััะตัะพะผ ะดะพัััะฟะพะฒ (30 ะดะฝะตะน ะพั ะดะฐัั ะฟะปะฐัะตะถะฐ, ะตัะปะธ ะฝะต ะฟัะพััะพัะตะฝะพ)
   - ะกะพะทะดะฐะฝะธะต ะธััะพัะธัะตัะบะธั ัะดะตะปะพะบ ะฑะตะท ะดะพัััะฟะพะฒ (ะตัะปะธ ะดะฐัะฐ > 30 ะดะฝะตะน ะฝะฐะทะฐะด)

2. **ะัะฟัะฐะฒะปะตะฝะธะต ะฟะพะปััะตะฝะธั ัะตะบะพะฒ** โ ัะฝััั ะพะณัะฐะฝะธัะตะฝะธะต "ะฝัะถะฝะฐ ัะดะตะปะบะฐ" ะดะปั batch-ะฟะพะปััะตะฝะธั ัะตะบะพะฒ

## ะขะตะบััะตะต ัะพััะพัะฝะธะต

### ะะฝะพะฟะบะฐ "ะะฒัะพัะฒัะทะฐัั ัะดะตะปะบะธ"
- ะะฐะฑะพัะฐะตั ัะพะปัะบะพ ะดะปั ะฟะปะฐัะตะถะตะน ั `tracking_id` (ORD-...)
- ะกะฒัะทัะฒะฐะตั ัััะตััะฒัััะธะต ัะดะตะปะบะธ, ะฝะต ัะพะทะดะฐัั ะฝะพะฒัะต
- ะะต ะฟะพะดัะพะดะธั ะดะปั ะผะฐััะพะฒะพะณะพ ัะพะทะดะฐะฝะธั

### ะะฝะพะฟะบะฐ "ะะพะปััะธัั ัะตะบะธ"
- ะขัะตะฑัะตั `order_id` โ ะฟะปะฐัะตะถะธ ะฑะตะท ัะดะตะปะบะธ ะฟัะพะฟััะบะฐัััั
- Edge function `bepaid-get-payment-docs` ัะฐะฑะพัะฐะตั ัะตัะตะท `order_id`

### ะขะตะบััะธะน ัะพัะผะฐั order_number
ะัะธะผะตัั: `ORD-26-MLCDEP69`, `REN-MLBWO9HO`, `SUB-26-MLBFH0MXO4KI`, `ORD-ADM-1770542415363`

---

## ะะตัะตะฝะธะต

### ะงะฐััั 1: ะะฐััะพะฒะพะต ัะพะทะดะฐะฝะธะต ัะดะตะปะพะบ

#### 1.1 ะะพะฒัะน ะบะพะผะฟะพะฝะตะฝั `BulkCreateDealsDialog.tsx`

ะะธะฐะปะพะณ ะดะปั ะผะฐััะพะฒะพะณะพ ัะพะทะดะฐะฝะธั ัะดะตะปะพะบ ัะพ ัะปะตะดัััะธะผะธ ะฟะพะปัะผะธ:

```text
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฆ ะกะพะทะดะฐัั ัะดะตะปะบะธ ะธะท ะฟะปะฐัะตะถะตะน                          โ
โ                                                         โ
โ  ะัะฑัะฐะฝะพ ะฟะปะฐัะตะถะตะน: 16                                   โ
โ  ะะพะฝัะฐะบัะพะฒ: 1 (ะขะฐัััะฝะฐ ะะตะปัะฝะตะฝัะบะฐั)                     โ
โ                                                         โ
โ  ะัะพะดัะบั:  [โผ Gorbova Club            ]                โ
โ  ะขะฐัะธั:    [โผ ะะถะตะผะตัััะฝะฐั ะฟะพะดะฟะธัะบะฐ    ]                โ
โ  ะกัะพะธะผะพััั: [250.00] BYN  (ััะตะดะฝัั ะธะท ะฒัะฑัะฐะฝะฝัั)        โ
โ                                                         โ
โ  โ ะัะดะฐัั ะดะพัััะฟ (ัะพะปัะบะพ ะดะปั ะฟะปะฐัะตะถะตะน < 30 ะดะฝะตะน)       โ
โ  ะะตัะธะพะด ะดะพัััะฟะฐ: 30 ะดะฝะตะน ะพั ะดะฐัั ะฟะปะฐัะตะถะฐ                โ
โ                                                         โ
โ  โ๏ธ ะััะพัะธัะตัะบะธะต ะฟะปะฐัะตะถะธ (>30 ะดะฝะตะน): 14 ัั              โ
โ     ะัะดัั ัะพะทะดะฐะฝั ัะพะปัะบะพ ัะดะตะปะบะธ ะฑะตะท ะดะพัััะฟะฐ             โ
โ                                                         โ
โ  [ะัะตะดะฟัะพัะผะพัั]              [ะัะผะตะฝะฐ] [ะกะพะทะดะฐัั ัะดะตะปะบะธ] โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 1.2 ะะพะณะธะบะฐ ะฝัะผะตัะฐัะธะธ ัะดะตะปะพะบ

**ะคะพัะผะฐั ะฝะพะผะตัะฐ:**
```
{ะฟะพััะดะบะพะฒัะน_ะฝะพะผะตั}-{product_code}-{profile_short}-{timestamp}
```

ะัะธะผะตั: `5-club-TZ-MLCDEP69` (5-ั ะฟะพะบัะฟะบะฐ ะบะปัะฑะฐ ะบะพะฝัะฐะบัะพะผ TZ)

**ะะปะณะพัะธัะผ:**
1. ะััะฟะฟะธัะพะฒะฐัั ะฒัะฑัะฐะฝะฝัะต ะฟะปะฐัะตะถะธ ะฟะพ `profile_id`
2. ะะปั ะบะฐะถะดะพะณะพ ะบะพะฝัะฐะบัะฐ ะฟะพะปััะธัั ัะตะบััะตะต ะบะพะปะธัะตััะฒะพ ัะดะตะปะพะบ ะฟะพ ััะพะผั `product_id`:
   ```sql
   SELECT COUNT(*) FROM orders_v2 
   WHERE profile_id = :profile_id 
     AND product_id = :product_id 
     AND status IN ('paid', 'refunded', 'canceled')
   ```
3. ะััะพััะธัะพะฒะฐัั ะฟะปะฐัะตะถะธ ะบะพะฝัะฐะบัะฐ ะฟะพ `paid_at` ASC
4. ะัะผะตัะพะฒะฐัั: `existing_count + 1`, `existing_count + 2`, ...

#### 1.3 ะกะพะทะดะฐะฝะธะต ัะดะตะปะบะธ (ะดะปั ะบะฐะถะดะพะณะพ ะฟะปะฐัะตะถะฐ)

```typescript
// ะัะตะฒะดะพะบะพะด
for (const payment of sortedPayments) {
  const dealNumber = baseCount + index + 1;
  const orderNumber = `${dealNumber}-${productCode}-${profileShort}-${timestamp}`;
  
  const accessStart = new Date(payment.paid_at);
  const accessEnd = addDays(accessStart, 30);
  const isExpired = accessEnd < new Date();
  
  // ะกะพะทะดะฐัั order
  await supabase.from('orders_v2').insert({
    order_number: orderNumber,
    profile_id: payment.profile_id,
    user_id: profile.user_id,
    product_id: selectedProductId,
    tariff_id: selectedTariffId,
    final_price: payment.amount,
    currency: payment.currency,
    status: 'paid',
    created_at: payment.paid_at, // ะััะพัะธัะตัะบะฐั ะดะฐัะฐ
    meta: {
      source: 'admin_bulk_from_payments',
      payment_ids: [payment.id],
      deal_sequence: dealNumber,
      is_historical: isExpired,
    }
  });
  
  // ะกะฒัะทะฐัั ะฟะปะฐัะตะถ ัะพ ัะดะตะปะบะพะน
  await supabase.from('payments_v2').update({
    order_id: newOrder.id
  }).eq('id', payment.id);
  
  // ะัะดะฐัั ะดะพัััะฟ ัะพะปัะบะพ ะตัะปะธ:
  // - ะะฐะปะพัะบะฐ "ะัะดะฐัั ะดะพัััะฟ" ะฒะบะปััะตะฝะฐ
  // - ะะต ghost ะบะพะฝัะฐะบั
  // - ะะตัะธะพะด ะฝะต ะธัััะบ
  if (grantAccess && !isGhost && !isExpired) {
    // ะกะพะทะดะฐัั subscription_v2, telegram_access_grants, etc.
  }
}
```

#### 1.4 ะะฑะฝะพะฒะปะตะฝะธะต `PaymentsBatchActions.tsx`

ะะพะฑะฐะฒะธัั ะบะฝะพะฟะบั "ะะฒัะพัะพะทะดะฐัั ัะดะตะปะบะธ":

```tsx
<Button onClick={() => setCreateDealsDialogOpen(true)}>
  <Plus className="h-4 w-4 mr-2" />
  ะะฒัะพัะพะทะดะฐัั ัะดะตะปะบะธ
</Button>
```

---

### ะงะฐััั 2: ะัะฟัะฐะฒะปะตะฝะธะต ะฟะพะปััะตะฝะธั ัะตะบะพะฒ

#### 2.1 ะัะพะฑะปะตะผะฐ

ะขะตะบััะฐั ะปะพะณะธะบะฐ ะฒ `PaymentsBatchActions.tsx`:
```typescript
const eligiblePayments = selectedPayments.filter(p => p.order_id && !p.receipt_url);
```

Edge function `bepaid-get-payment-docs` ััะตะฑัะตั `order_id` ะดะปั ะฟะพะธัะบะฐ payment.

#### 2.2 ะะตัะตะฝะธะต

**ะะฐัะธะฐะฝั A (ัะตะบะพะผะตะฝะดัะตััั):** ะกะพะทะดะฐัั ะฝะพะฒัะน endpoint ะธะปะธ ะผะพะดะธัะธัะธัะพะฒะฐัั batch actions ะดะปั ะฟััะผะพะณะพ ะทะฐะฟัะพัะฐ ะฟะพ `provider_payment_id`:

1. ะะทะผะตะฝะธัั ัะธะปััั ะฒ `handleFetchReceipts`:
   ```typescript
   // ะัะปะพ: ััะตะฑะพะฒะฐัั order_id
   const eligiblePayments = selectedPayments.filter(p => p.order_id && !p.receipt_url);
   
   // ะกัะฐะฝะตั: ััะตะฑะพะฒะฐัั ัะพะปัะบะพ provider_payment_id
   const eligiblePayments = selectedPayments.filter(p => 
     !p.receipt_url && 
     (p.uid || p.tracking_id) // provider_payment_id ะดะพัััะฟะตะฝ ัะตัะตะท uid
   );
   ```

2. ะกะพะทะดะฐัั ะฝะพะฒัะน edge function `bepaid-fetch-receipt-by-uid`:
   ```typescript
   // ะัะธะฝะธะผะฐะตั: provider_payment_id (uid ะธะท bePaid)
   // ะะฐัะพะดะธั payment ะฒ payments_v2 ะฟะพ provider_payment_id
   // ะะฐะฟัะฐัะธะฒะฐะตั ัะตะบ ั bePaid
   // ะะฑะฝะพะฒะปัะตั receipt_url
   ```

   ะะปะธ ะผะพะดะธัะธัะธัะพะฒะฐัั ัััะตััะฒัััะธะน `bepaid-get-payment-docs` ะดะปั ะฟะพะดะดะตัะถะบะธ ะฟะฐัะฐะผะตััะฐ `payment_id` ะฝะฐะฟััะผัั (ะฑะตะท order_id).

3. ะะฑะฝะพะฒะธัั ะฒัะทะพะฒ ะฒ batch actions:
   ```typescript
   // ะะปั ะฟะปะฐัะตะถะตะน ั order_id - ะธัะฟะพะปัะทะพะฒะฐัั ัััะตััะฒัััะธะน endpoint
   // ะะปั ะฟะปะฐัะตะถะตะน ะฑะตะท order_id - ะธัะฟะพะปัะทะพะฒะฐัั ะฟััะผะพะน ะทะฐะฟัะพั ะฟะพ payment_id
   ```

---

## ะคะฐะนะปั ะดะปั ัะพะทะดะฐะฝะธั/ะธะทะผะตะฝะตะฝะธั

### ะะพะฒัะต ัะฐะนะปั
| ะคะฐะนะป | ะะฟะธัะฐะฝะธะต |
|------|----------|
| `src/components/admin/payments/BulkCreateDealsDialog.tsx` | ะะธะฐะปะพะณ ะผะฐััะพะฒะพะณะพ ัะพะทะดะฐะฝะธั ัะดะตะปะพะบ |

### ะะทะผะตะฝัะตะผัะต ัะฐะนะปั
| ะคะฐะนะป | ะะทะผะตะฝะตะฝะธั |
|------|-----------|
| `src/components/admin/payments/PaymentsBatchActions.tsx` | ะะพะฑะฐะฒะธัั ะบะฝะพะฟะบั "ะะฒัะพัะพะทะดะฐัั ัะดะตะปะบะธ", ะธัะฟัะฐะฒะธัั ัะธะปััั ัะตะบะพะฒ |
| `supabase/functions/bepaid-get-payment-docs/index.ts` | ะะพะฑะฐะฒะธัั ะฟะพะดะดะตัะถะบั `payment_id` ะบะฐะบ ะฐะปััะตัะฝะฐัะธะฒั `order_id` |

---

## ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ

### ะัะผะตัะฐัะธั ัะดะตะปะพะบ โ ะฟัะธะผะตั

ะะพะฝัะฐะบั: ะขะฐัััะฝะฐ ะะตะปัะฝะตะฝัะบะฐั (profile_id: abc123)
ะัะพะดัะบั: Gorbova Club (code: club)
ะกััะตััะฒัััะธะต ัะดะตะปะบะธ ะฟะพ ะบะปัะฑั: 3

ะัะฑัะฐะฝะฝัะต ะฟะปะฐัะตะถะธ (ะพััะพััะธัะพะฒะฐะฝั ะฟะพ ะดะฐัะต):
1. 2025-01-15 โ 250 BYN โ ะกะดะตะปะบะฐ `4-club-TZ-...`
2. 2025-02-15 โ 250 BYN โ ะกะดะตะปะบะฐ `5-club-TZ-...`
3. 2025-03-15 โ 250 BYN โ ะกะดะตะปะบะฐ `6-club-TZ-...`
...
16. 2026-01-15 โ 250 BYN โ ะกะดะตะปะบะฐ `19-club-TZ-...`

### ะััะพัะธัะตัะบะธะต ัะดะตะปะบะธ (>30 ะดะฝะตะน)

ะะปั ะฟะปะฐัะตะถะตะน ั `paid_at` ะฑะพะปะตะต 30 ะดะฝะตะน ะฝะฐะทะฐะด:
- ะกะพะทะดะฐัััั ัะพะปัะบะพ `orders_v2` ะทะฐะฟะธัั
- ะะ ัะพะทะดะฐัััั `subscriptions_v2`
- ะะ ะฒัะดะฐัััั Telegram ะดะพัััะฟ
- ะ meta: `is_historical: true`, `deal_only: true`

### ะััะฟะฟะพะฒะฐั ะพะฑัะฐะฑะพัะบะฐ

ะงัะพะฑั ะฝะต ะฟะตัะตะณััะถะฐัั ะะ:
- Batch limit: 100 ะฟะปะฐัะตะถะตะน ะทะฐ ัะฐะท
- Delay ะผะตะถะดั ะทะฐะฟะธััะผะธ: 100ms
- STOP-guard ะฟัะธ >20% ะพัะธะฑะพะบ

---

## DoD (ะบัะธัะตัะธะธ ะฟัะธัะผะบะธ)

1. **UI**: ะะฝะพะฟะบะฐ "ะะฒัะพัะพะทะดะฐัั ัะดะตะปะบะธ" ะฒะธะดะฝะฐ ะฟัะธ ะฒัะฑะพัะต ะฟะปะฐัะตะถะตะน
2. **ะะธะฐะปะพะณ**: ะะพะบะฐะทัะฒะฐะตั ะบะพะปะธัะตััะฒะพ ะฟะปะฐัะตะถะตะน, ะบะพะฝัะฐะบัะพะฒ, ะฟะพะทะฒะพะปัะตั ะฒัะฑัะฐัั ะฟัะพะดัะบั/ัะฐัะธั
3. **ะัะผะตัะฐัะธั**: ะกะดะตะปะบะธ ะฟะพะปััะฐัั ะฟะพััะดะบะพะฒัะต ะฝะพะผะตัะฐ ะฟะพ ะบะพะฝัะฐะบัั+ะฟัะพะดัะบัั
4. **ะััะพัะธั**: ะกะดะตะปะบะธ ััะฐััะต 30 ะดะฝะตะน ัะพะทะดะฐัััั ะฑะตะท ะดะพัััะฟะพะฒ
5. **ะกะฒัะทัะฒะฐะฝะธะต**: ะะปะฐัะตะถะธ ัะฒัะทัะฒะฐัััั ั ัะพะทะดะฐะฝะฝัะผะธ ัะดะตะปะบะฐะผะธ (`payments_v2.order_id`)
6. **ะงะตะบะธ**: ะะฝะพะฟะบะฐ "ะะพะปััะธัั ัะตะบะธ" ัะฐะฑะพัะฐะตั ะดะปั ะฟะปะฐัะตะถะตะน ะฑะตะท ัะดะตะปะพะบ
7. **SQL-ะฟััั**: 
   ```sql
   SELECT order_number, profile_id, product_id, created_at
   FROM orders_v2
   WHERE meta->>'source' = 'admin_bulk_from_payments'
   ORDER BY created_at DESC
   LIMIT 20;
   ```
8. **UI-ัะบัะธะฝ**: ะะพะบะฐะทะฐัั ัะตะทัะปััะฐั ัะพะทะดะฐะฝะธั ัะดะตะปะพะบ ะฒ ะฐะดะผะธะฝะบะต

---

## ะะธัะบะธ ะธ ะพะณัะฐะฝะธัะตะฝะธั

1. **ะัะฑะปะธะบะฐัั**: ะัะปะธ ะฟะปะฐัะตะถ ัะถะต ัะฒัะทะฐะฝ ัะพ ัะดะตะปะบะพะน โ ะฟัะพะฟััะบะฐะตะผ
2. **Ghost ะบะพะฝัะฐะบัั**: ะะต ะผะพะณัั ะฟะพะปััะธัั ะดะพัััะฟ (ัะพะปัะบะพ ัะดะตะปะบะฐ)
3. **ะะฐะทะฝัะต ััะผะผั**: ะัะปะธ ะฟะปะฐัะตะถะธ ะธะผะตัั ัะฐะทะฝัะต ััะผะผั โ ะธัะฟะพะปัะทัะตะผ ััะผะผั ะบะฐะถะดะพะณะพ ะฟะปะฐัะตะถะฐ
4. **ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั**: ะัะธ >100 ะฟะปะฐัะตะถะฐั โ ะฑะฐััะฐะผะธ ั ะฟัะพะณัะตัั-ะฑะฐัะพะผ

---

## STOP-guards

- ะะต ัะพะทะดะฐะฒะฐัั ัะดะตะปะบั ะตัะปะธ ะฟะปะฐัะตะถ ัะถะต ะธะผะตะตั `order_id`
- ะะต ะฒัะดะฐะฒะฐัั ะดะพัััะฟ ghost-ะบะพะฝัะฐะบัะฐะผ
- ะะต ะฒัะดะฐะฒะฐัั ะดะพัััะฟ ะฟะพ ะธััะตะบัะธะผ ะฟะตัะธะพะดะฐะผ
- ะะธะผะธั 100 ะฟะปะฐัะตะถะตะน ะทะฐ ะพะฟะตัะฐัะธั
- ะััะฐะฝะพะฒะบะฐ ะฟัะธ >20% ะพัะธะฑะพะบ



ะัะธะฝััะพ ะฟะพ ะฟัะพัะปัะผ ะฟะฐััะฐะผ P0.5 ะฟะพ ัะฐะบัะฐะผ ะทะฐะบััั โ

ะงัะพ ัะตะฟะตัั ะฒะฐะถะฝะพ (ะฑะตะท ัะฐัััะณะธะฒะฐะฝะธั):
	1.	ะะดะธะฝ ัะธะฝะฐะปัะฝัะน โregression guardโ SQL (ััะพะฑั ััะพ ะฝะต ัะปะพะผะฐะปะธ ัะปะตะดัััะธะผ ะฟะฐััะตะผ):

-- verify_* ะฒัะตะณะดะฐ ะฟะพัะฒะปัะตััั ะดะฐะถะต ะฟัะธ retry
SELECT count(*)
FROM payment_methods
WHERE meta->>'verify_payment_id' IS NULL
  AND meta->>'verify_job_id' IS NULL
  AND meta->>'verify_attempt' IS NULL
  AND verification_status = 'pending'
  AND updated_at > now() - interval '24 hours';
-- ะะถะธะดะฐะฝะธะต: 0

	2.	ะัะพะฒะตัะบะฐ STOP-guard ะฝะต ะผะตัะฐะตั ะพะฑะฝะพะฒะปะตะฝะธั next_retry_at (1 ะบะตะนั ะดะพััะฐัะพัะฝะพ):
ััะฐะฒะฝะธัั verify_next_retry_at ะดะพ/ะฟะพัะปะต ะพะดะฝะพะณะพ retry.
	3.	ะะฐะปััะต ะปะพะณะธัะฝัะน ัะปะตะดัััะธะน P0/P1 ะฑะปะพะบ: ะผะฐััะพะฒะฐั ะผะธะณัะฐัะธั Deno.env.get('BEPAID_') โ getBepaidCredsStrict() (ั grep-DoD ะธ ัะฟะธัะบะพะผ ััะฝะบัะธะน P0/P1).
