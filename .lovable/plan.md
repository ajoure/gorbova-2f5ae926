Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ payments_v2 Ñ Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ¾Ğ¹ bePaid â€” Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½
ĞĞ±Ğ·Ğ¾Ñ€ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                ĞŸĞ›ĞĞ¢Ğ•Ğ–Ğ˜ (Payments Hub)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚  [Sync â–¾]                                           [âš™ï¸ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹]              â”‚
â”‚     â”‚                                                      â”‚                      â”‚
â”‚     â”œâ”€â”€ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ API        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”œâ”€â”€ Ğ¡Ğ²ĞµÑ€ĞºĞ° Ñ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ¾Ğ¼  â”‚
â”‚     â”‚   (Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹)                       â”‚  â”œâ”€â”€ ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ     â”‚
â”‚     â”‚                                                   â”‚  â””â”€â”€ Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸   â”‚
â”‚     â””â”€â”€ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ¾Ğ¹   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚         (ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ½Ğ°Ñ ÑĞ²ĞµÑ€ĞºĞ° + ĞºĞ°ÑĞºĞ°Ğ´)                     â”‚      ĞĞĞ’Ğ«Ğ™ ĞŸĞ£ĞĞšĞ¢        â”‚
â”‚                                                         â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
1. Ğ”Ğ²Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
1.1 "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ API" (ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ°Ñ)
Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ: Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº bePaid webhook Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹
Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°: Ğ‘ĞµĞ· Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ´Ğ°Ñ‚ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ "ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğµ?"
Ğ¤Ğ°Ğ¹Ğ»: SyncRunDialog.tsx (ÑƒĞ¶Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾)
1.2 "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ¾Ğ¹" (ĞĞĞ’ĞĞ¯)
Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ: ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑĞ²ĞµÑ€ĞºĞ° Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¾Ğ¹ bePaid
Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ° = Ğ­Ğ¢ĞĞ›ĞĞ (source of truth)
Ğ¤Ğ°Ğ¹Ğ»: SyncWithStatementDialog.tsx (ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ)
2. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ¾Ğ¹
2.1 ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° ÑĞ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ UID
Ğ¡Ğ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ	Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ
UID ĞµÑÑ‚ÑŒ Ğ² Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞµ Ğ˜ Ğ² payments_v2	Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ñ
UID ĞµÑÑ‚ÑŒ Ğ² Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞµ, ĞĞ•Ğ¢ Ğ² payments_v2	Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² payments_v2
UID ĞµÑÑ‚ÑŒ Ğ² payments_v2, ĞĞ•Ğ¢ Ğ² Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞµ (Ğ·Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´)	Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· payments_v2 + ĞºĞ°ÑĞºĞ°Ğ´
Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ Ñ paid_at Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ´Ğ°Ñ‚ Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¸!

2.2 ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ĞµĞ¹ (ĞºĞ¾Ğ³Ğ´Ğ° UID ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚)

Ğ­Ñ‚Ğ°Ğ»Ğ¾Ğ½ (bepaid_statement_rows)â†’ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ (payments_v2)uidâ†’provider_payment_idamountâ†’amountstatus (Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹)â†’statustransaction_typeâ†’transaction_typepaid_atâ†’paid_atcard_masked â†’ last4â†’card_last4card_masked â†’ brandâ†’card_brandcard_holderâ†’card_holder âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ commission_totalâ†’meta.commission_totalpayout_amountâ†’meta.payout_amount


3. ĞšĞ°ÑĞºĞ°Ğ´Ğ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸
3.1 Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑÑƒĞ¼Ğ¼Ñ‹ (amount)
ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: payments_v2 = 100 BYN, Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ° = 1 BYN


1. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ payments_v2.amount = 1
2. ĞĞ°Ğ¹Ñ‚Ğ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ order (payments_v2.order_id)
3. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ orders_v2:
   - base_price = 1
   - final_price = 1
   - paid_amount = 1
4. Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ² audit_logs
3.2 Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° (status)
ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: payments_v2 = "succeeded", Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ° = "failed"


1. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ payments_v2.status = "failed"
2. ĞĞ°Ğ¹Ñ‚Ğ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚Ğ¸:
   - orders_v2 (Ñ‡ĞµÑ€ĞµĞ· order_id)
   - subscriptions_v2 (Ñ‡ĞµÑ€ĞµĞ· user_id + product_id)
   - entitlements (Ñ‡ĞµÑ€ĞµĞ· user_id + order_id)
   - telegram_access_grants (Ñ‡ĞµÑ€ĞµĞ· user_id)
3. ĞšĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ/Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ:
   - orders_v2.status = "cancelled"
   - subscriptions_v2: status = "cancelled", auto_renew = false
   - entitlements.status = "revoked"
   - Ğ’Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ telegram-revoke-access (ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ» Ğ´Ğ¾ÑÑ‚ÑƒĞ¿)
4. Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² audit_logs + ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°
3.3 Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ (UID Ğ½ĞµÑ‚ Ğ² Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞµ)

1. ĞĞ°Ğ¹Ñ‚Ğ¸ payment Ğ¿Ğ¾ UID
2. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ°ÑĞºĞ°Ğ´ ĞºĞ°Ğº Ğ¿Ñ€Ğ¸ status â†’ failed
3. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¸Ğ· payments_v2
4. Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² audit_logs:
   - action: "payment.deleted_not_in_statement"
   - meta: { uid, reason, cascaded_entities }
4. UI Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
4.1 Ğ­ĞºÑ€Ğ°Ğ½ Ğ¿Ñ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° (dry-run)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ¾Ğ¹ bePaid                                    [âœ•]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚ Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ° bePaid = Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¸ÑÑ‚Ğ¸Ğ½Ñ‹. Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² "ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ°Ñ…" Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹           â”‚
â”‚ Ğ² ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¾Ğ¹ Ğ·Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´.                      â”‚
â”‚                                                                                 â”‚
â”‚ ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¸: [2026-01-01] â€” [2026-01-25]                                    â”‚
â”‚                                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ â”‚  Ğ’ Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞµ    â”‚  Ğ’ payments   â”‚   Ğ¡Ğ¾Ğ²Ğ¿Ğ°Ğ»Ğ¾     â”‚  Ğ Ğ°ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğ¹  â”‚              â”‚
â”‚ â”‚     682       â”‚     650       â”‚     630       â”‚      52       â”‚              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                 â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚                                                                                 â”‚
â”‚ âš¡ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ¯ Ğš ĞŸĞ Ğ˜ĞœĞ•ĞĞ•ĞĞ˜Ğ®:                                                      â”‚
â”‚                                                                                 â”‚
â”‚ â”Œâ”€ ğŸ“¥ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ (22 Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ â˜‘ 99c8a... â”‚ 250.00 BYN â”‚ Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ â”‚ 03.01.2026 19:07    [Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ â–¾]        â”‚â”‚
â”‚ â”‚ â˜‘ 8b2f1... â”‚ 100.00 BYN â”‚ Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ â”‚ 05.01.2026 12:33    [Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ â–¾]        â”‚â”‚
â”‚ â”‚ ...                                                                         â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚ â”Œâ”€ âœï¸ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ (15 Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ â˜‘ a1b2c... â”‚ Ğ¡ÑƒĞ¼Ğ¼Ğ°: 100â†’1 â”‚ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: âœ“ â”‚ âš ï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ ÑĞ´ĞµĞ»ĞºÑƒ ORD-26-00123     â”‚â”‚
â”‚ â”‚   â”œâ”€ payments_v2:  100.00 BYN, succeeded                          ğŸ”´        â”‚â”‚
â”‚ â”‚   â””â”€ Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ°:        1.00 BYN, succeeded                          ğŸŸ¢        â”‚â”‚
â”‚ â”‚                                                                             â”‚â”‚
â”‚ â”‚ â˜ f3e4d... â”‚ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: succeededâ†’failed â”‚ âš ï¸ Ğ£Ğ”ĞĞ›Ğ˜Ğ¢ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿!                   â”‚â”‚
â”‚ â”‚   â”œâ”€ payments_v2:  250.00 BYN, succeeded                          ğŸ”´        â”‚â”‚
â”‚ â”‚   â””â”€ Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ°:      250.00 BYN, failed                             ğŸŸ¢        â”‚â”‚
â”‚ â”‚   â””â”€ âš ï¸ ĞšĞ°ÑĞºĞ°Ğ´: 1 ÑĞ´ĞµĞ»ĞºĞ°, 1 Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°, 1 entitlement, Telegram Ğ´Ğ¾ÑÑ‚ÑƒĞ¿       â”‚â”‚
â”‚ â”‚ ...                                                                         â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚ â”Œâ”€ ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ (3 Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ â˜ x9y8z... â”‚ 150.00 BYN â”‚ succeeded â”‚ ĞĞµÑ‚ Ğ² Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞµ Ğ·Ğ° 01-25.01.2026       â”‚â”‚
â”‚ â”‚   â””â”€ âš ï¸ ĞšĞ°ÑĞºĞ°Ğ´: 1 ÑĞ´ĞµĞ»ĞºĞ°, 1 Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°, 0 entitlements                       â”‚â”‚
â”‚ â”‚ â˜ m5n6o... â”‚ 50.00 BYN  â”‚ succeeded â”‚ ĞĞµÑ‚ Ğ² Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞµ Ğ·Ğ° 01-25.01.2026       â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚                                                                                 â”‚
â”‚ Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°: ğŸ”´ Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ (payments_v2)  ğŸŸ¢ Ğ­Ñ‚Ğ°Ğ»Ğ¾Ğ½ (Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ° bePaid)                  â”‚
â”‚                                                                                 â”‚
â”‚ â˜‘ Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾: 37 Ğ¸Ğ· 40    [Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ] [Ğ¡Ğ½ÑÑ‚ÑŒ Ğ²ÑĞµ] [Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğµ]          â”‚
â”‚                                                                                 â”‚
â”‚                               [ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°]  [ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ (37)]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
4.2 Ğ¦Ğ²ĞµÑ‚Ğ¾Ğ²Ğ°Ñ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
Ğ¦Ğ²ĞµÑ‚	Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
ğŸ”´ ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹	Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² payments_v2 (Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ñƒ Ğ½Ğ°Ñ)
ğŸŸ¢ Ğ—ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹	Ğ­Ñ‚Ğ°Ğ»Ğ¾Ğ½ Ğ¸Ğ· Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¸ bePaid (Ğ¸ÑÑ‚Ğ¸Ğ½Ğ°)
âš ï¸ Ğ–Ñ‘Ğ»Ñ‚Ñ‹Ğ¹	ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ñ‹Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑÑ…
4.3 Ğ’Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ
Ğ§ĞµĞºĞ±Ğ¾ĞºÑÑ‹ Ñƒ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸
ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: Ğ’ÑĞµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ñ‹
"Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğµ": Ğ¡Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹, Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‰Ğ¸Ñ… ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ
Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ÑĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ¸Ğ· Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
5. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Edge Function
5.1 Ğ¤Ğ°Ğ¹Ğ»: supabase/functions/sync-payments-with-statement/index.ts

interface SyncRequest {
  from_date: string;        // "2026-01-01"
  to_date: string;          // "2026-01-25"
  dry_run?: boolean;        // true = Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€
  selected_uids?: string[]; // ĞšĞ°ĞºĞ¸Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑÑ‚ÑŒ (null = Ğ²ÑĞµ)
}

interface SyncChange {
  uid: string;
  action: 'create' | 'update' | 'delete';
  
  // Ğ”Ğ»Ñ update: Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ñ
  differences?: {
    field: string;
    current: string | number;      // ğŸ”´ payments_v2
    statement: string | number;    // ğŸŸ¢ Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ°
  }[];
  
  // ĞšĞ°ÑĞºĞ°Ğ´Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ
  cascade?: {
    orders: { id: string; action: 'update' | 'cancel'; current_status: string }[];
    subscriptions: { id: string; action: 'cancel' }[];
    entitlements: { id: string; action: 'revoke' }[];
    telegram_access: boolean;
  };
  
  // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¸
  statement_data: {
    amount: number;
    status: string;
    transaction_type: string;
    paid_at: string;
    // ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ
  };
  
  // ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚ (ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½)
  contact?: {
    id: string;
    name: string;
    email: string;
  };
  
  // Ğ¤Ğ»Ğ°Ğ³ "Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ"
  is_dangerous: boolean;
}

interface SyncResult {
  success: boolean;
  dry_run: boolean;
  stats: {
    statement_count: number;
    payments_count: number;
    matched: number;
    to_create: number;
    to_update: number;
    to_delete: number;
    applied: number;
    skipped: number;
  };
  changes: SyncChange[];
  audit_log_id?: string;
}
5.2 ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼

async function syncWithStatement(req: SyncRequest): Promise<SyncResult> {
  const changes: SyncChange[] = [];
  
  // 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´
  const statement = await loadStatement(req.from_date, req.to_date);
  const payments = await loadPayments(req.from_date, req.to_date);
  
  // 2. ĞŸĞ¾ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹
  const stmtByUid = new Map(statement.map(s => [s.uid, s]));
  const pmtByUid = new Map(payments.map(p => [p.provider_payment_id, p]));
  
  // 3. ĞĞ°Ğ¹Ñ‚Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ¯ (ĞµÑÑ‚ÑŒ Ğ² Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞµ, Ğ½ĞµÑ‚ Ğ² payments)
  for (const [uid, stmt] of stmtByUid) {
    if (!pmtByUid.has(uid)) {
      changes.push({
        uid,
        action: 'create',
        statement_data: stmt,
        is_dangerous: false,
      });
    }
  }
  
  // 4. ĞĞ°Ğ¹Ñ‚Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ (ĞµÑÑ‚ÑŒ Ğ² Ğ¾Ğ±Ğ¾Ğ¸Ñ…, Ğ½Ğ¾ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ°ÑÑ‚ÑÑ)
  for (const [uid, pmt] of pmtByUid) {
    const stmt = stmtByUid.get(uid);
    if (stmt) {
      const diffs = compareFields(pmt, stmt);
      if (diffs.length > 0) {
        const cascade = await calculateCascade(pmt, stmt);
        changes.push({
          uid,
          action: 'update',
          differences: diffs,
          cascade,
          statement_data: stmt,
          contact: await getContact(pmt.profile_id),
          is_dangerous: cascade.telegram_access || 
                       stmt.status !== pmt.status,
        });
      }
    }
  }
  
  // 5. ĞĞ°Ğ¹Ñ‚Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ¯ (ĞµÑÑ‚ÑŒ Ğ² payments, Ğ½ĞµÑ‚ Ğ² Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞµ)
  for (const [uid, pmt] of pmtByUid) {
    if (!stmtByUid.has(uid)) {
      // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ paid_at Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ² Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ´Ğ°Ñ‚ Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¸!
      if (isWithinDateRange(pmt.paid_at, req.from_date, req.to_date)) {
        const cascade = await calculateCascadeForDelete(pmt);
        changes.push({
          uid,
          action: 'delete',
          cascade,
          statement_data: null,
          contact: await getContact(pmt.profile_id),
          is_dangerous: true,
        });
      }
    }
  }
  
  // 6. Ğ•ÑĞ»Ğ¸ Ğ½Ğµ dry_run â€” Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
  if (!req.dry_run) {
    const uidsToApply = req.selected_uids || changes.map(c => c.uid);
    for (const change of changes) {
      if (uidsToApply.includes(change.uid)) {
        await applyChange(change);
      }
    }
  }
  
  return { success: true, dry_run: req.dry_run, changes, stats: {...} };
}
5.3 Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ñ‹Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

async function applyChange(change: SyncChange) {
  if (change.action === 'create') {
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² payments_v2
    await createPayment(change.statement_data);
    await logAudit('payment.created_from_statement', change);
  }
  
  if (change.action === 'update') {
    const pmt = await getPayment(change.uid);
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ payments_v2
    await updatePayment(change.uid, change.statement_data);
    
    // Ğ•ÑĞ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ°ÑÑŒ ÑÑƒĞ¼Ğ¼Ğ° â€” Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ´ĞµĞ»ĞºÑƒ
    if (change.differences.some(d => d.field === 'amount')) {
      await updateOrderAmount(pmt.order_id, change.statement_data.amount);
    }
    
    // Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ Ğ½Ğ° failed/cancelled
    if (change.differences.some(d => d.field === 'status')) {
      const newStatus = normalizeStatus(change.statement_data.status);
      if (['failed', 'cancelled', 'refunded'].includes(newStatus)) {
        await revokeAccess(pmt);
      }
    }
    
    await logAudit('payment.updated_from_statement', change);
    await logToContactCard(change.contact?.id, change);
  }
  
  if (change.action === 'delete') {
    const pmt = await getPayment(change.uid);
    
    // ĞšĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
    await revokeAccess(pmt);
    
    // Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶
    await deletePayment(change.uid);
    
    await logAudit('payment.deleted_not_in_statement', change);
    await logToContactCard(change.contact?.id, change);
  }
}

async function revokeAccess(payment: Payment) {
  // 1. ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ´ĞµĞ»ĞºÑƒ
  if (payment.order_id) {
    await supabase.from('orders_v2')
      .update({ 
        status: 'cancelled',
        meta: { cancelled_by: 'statement_sync', cancelled_at: now() }
      })
      .eq('id', payment.order_id);
  }
  
  // 2. ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
  await supabase.from('subscriptions_v2')
    .update({ 
      status: 'cancelled', 
      auto_renew: false,
      meta: { cancelled_by: 'statement_sync' }
    })
    .eq('user_id', payment.user_id);
  
  // 3. ĞÑ‚Ğ¾Ğ·Ğ²Ğ°Ñ‚ÑŒ entitlements
  await supabase.from('entitlements')
    .update({ status: 'revoked' })
    .eq('order_id', payment.order_id);
  
  // 4. ĞÑ‚Ğ¾Ğ·Ğ²Ğ°Ñ‚ÑŒ Telegram Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
  await supabase.functions.invoke('telegram-revoke-access', {
    body: { user_id: payment.user_id }
  });
}
6. Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°
ĞŸÑ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² audit_logs:


await supabase.from('audit_logs').insert({
  actor_type: 'system',
  actor_user_id: null,
  actor_label: 'sync-payments-with-statement',
  action: 'payment.statement_sync',
  target_user_id: payment.user_id,
  meta: {
    uid: change.uid,
    action: change.action,  // 'create' | 'update' | 'delete'
    differences: change.differences,
    cascade: change.cascade,
    initiated_by: currentUser.id,
    initiated_by_email: currentUser.email,
    statement_period: `${from_date} â€” ${to_date}`,
  }
});
Ğ­Ñ‚Ğ¸ Ğ»Ğ¾Ğ³Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ÑÑ Ğ² ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ° Ğ² Ñ…Ñ€Ğ¾Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹.

7. Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ/Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ:
Ğ¤Ğ°Ğ¹Ğ»	ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
supabase/functions/sync-payments-with-statement/index.ts	Edge Function Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¾Ğ¹ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
src/components/admin/payments/SyncWithStatementDialog.tsx	UI Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ñ Ğ¿Ñ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¾Ğ¼ Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¼ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸ĞµĞ¼
Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ:
Ğ¤Ğ°Ğ¹Ğ»	Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ
src/components/admin/payments/SyncRunDialog.tsx	Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ñ‚Ğ¸Ğ¿Ğ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (API / Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ°) Ğ˜Ğ›Ğ˜ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½ÑƒÑ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
src/components/admin/payments/PaymentsTabContent.tsx	Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ/Ğ¼ĞµĞ½Ñ Ğ´Ğ»Ñ "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ¾Ğ¹"
8. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¼ĞµĞ½Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ A: Dropdown Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ Ğ½Ğ° "Sync"


[Sync â–¾]
  â”œâ”€â”€ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ API
  â”‚   â””â”€â”€ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ¾Ñ‚ bePaid
  â””â”€â”€ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ¾Ğ¹
      â””â”€â”€ Ğ¡Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¾Ğ¹
Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ B: Ğ”Ğ²Ğµ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸


[ğŸ”„ Sync API]  [ğŸ“‹ Sync Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ°]
Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒÑ Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ A â€” Ğ¾Ğ´Ğ¸Ğ½ dropdown Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ² ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸.

9. Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
9.1 Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ

// ĞĞµ ÑƒĞ´Ğ°Ğ»ÑÑ‚ÑŒ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ·Ğ° Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ°Ğ¼Ğ¸ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¸
if (payment.paid_at < from_date || payment.paid_at > to_date) {
  // ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ â€” Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ° Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğµ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹
  continue;
}

// ĞĞµ ÑƒĞ´Ğ°Ğ»ÑÑ‚ÑŒ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ñ origin != 'bepaid'
if (payment.origin !== 'bepaid') {
  // Ğ­Ñ‚Ğ¾ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ â€” Ğ½Ğµ Ñ‚Ñ€Ğ¾Ğ³Ğ°Ñ‚ÑŒ
  continue;
}
9.2 ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹

// Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ
const dangerousCount = changes.filter(c => c.is_dangerous).length;
if (dangerousCount > 0) {
  // Ğ’ UI Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ:
  // "âš ï¸ {dangerousCount} Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ²ĞµĞ´ÑƒÑ‚ Ğº Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñƒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°"
}
9.3 ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ admin Ğ¸Ğ»Ğ¸ superadmin Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
Ğ’ÑĞµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ñ‚Ğ¾Ñ€Ğ°
10. DoD (Definition of Done)
Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:
 Dry-run Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ’Ğ¡Ğ• Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ Ñ†Ğ²ĞµÑ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ†Ğ¸ĞµĞ¹
 ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ/Ğ¸ÑĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸
 Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ: UID Ğ¸Ğ· Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¸ â†’ Ğ½Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² payments_v2
 ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ĞµĞ¹ + ĞºĞ°ÑĞºĞ°Ğ´ Ğ½Ğ° ÑĞ´ĞµĞ»ĞºĞ¸/Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
 Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: UID Ğ½Ğµ Ğ² Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞµ â†’ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ + ĞºĞ°ÑĞºĞ°Ğ´ + Ğ¾Ñ‚Ğ·Ñ‹Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
 Telegram Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ½Ğ° failed
UI:
 ğŸ”´ ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹ = Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (payments_v2)
 ğŸŸ¢ Ğ—ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹ = ÑÑ‚Ğ°Ğ»Ğ¾Ğ½ (Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ°)
 âš ï¸ ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¾ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ñ‹Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑÑ…
 Ğ§ĞµĞºĞ±Ğ¾ĞºÑÑ‹ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
 ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğµ"
Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ:
 ĞĞµ ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ÑÑ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ·Ğ° Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ°Ğ¼Ğ¸ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
 ĞĞµ ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ÑÑ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ñ origin != 'bepaid'
 Ğ’ÑĞµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ² audit_logs
 Ğ›Ğ¾Ğ³Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ÑÑ Ğ² ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°