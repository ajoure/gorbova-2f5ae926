# PATCH P1.0.2 ‚Äî Support UI Fixes + Client Notifications + Reactions + Telegram Bridge

## –ñ—ë—Å—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è Lovable.dev (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
1) –ù–∏—á–µ–≥–æ –Ω–µ –ª–æ–º–∞—Ç—å –∏ –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å –ª–∏—à–Ω–µ–µ. –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ.
2) Add-only –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π diff. –ë–µ–∑ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ ‚Äú–∑–∞–æ–¥–Ω–æ‚Äù.
3) –í—Å–µ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: dry-run ‚Üí execute. –í–µ–∑–¥–µ STOP-guards (–ª–∏–º–∏—Ç—ã/–±–∞—Ç—á–∏/—Ç–∞–π–º–∞—É—Ç—ã).
4) –ù–∏–∫–∞–∫–∏—Ö —Ö–∞—Ä–¥–∫–æ–¥-UUID/–º–∞–≥–∏–∏. –¢–æ–ª—å–∫–æ –¥–æ–∫–∞–∑—É–µ–º—ã–µ —Å–≤—è–∑–∏.
5) –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: internal notes –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–ª–∞—Ç—å –≤ Telegram.
6) –§–∏–Ω–∞–ª—å–Ω—ã–π DoD —Ç–æ–ª—å–∫–æ –ø–æ —Ñ–∞–∫—Ç–∞–º: UI-—Å–∫—Ä–∏–Ω—ã + –ª–æ–≥–∏ + SQL-–ø—Ä–æ–≤–µ—Ä–∫–∏. –ï—Å–ª–∏ ‚Äú—Å–¥–µ–ª–∞–Ω–æ‚Äù –±–µ–∑ –ø—Ä—É—Ñ–æ–≤ ‚Äî —Å—á–∏—Ç–∞–µ—Ç—Å—è –ù–ï —Å–¥–µ–ª–∞–Ω–æ.

---

## P0 (TEST-ONLY HARDEN)
–¶–µ–ª—å: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –º–∞—Ä—à—Ä—É—Ç–µ /support/{ticketId} –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –Ω–µ –≤–∏–¥–Ω—ã –¥–∞–∂–µ –∞–¥–º–∏–Ω—É (route client).
- –ö–æ–¥ –º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ, —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.
DoD: –ø–æ–¥ admin-–∞–∫–∫–∞—É–Ω—Ç–æ–º –∑–∞–π—Ç–∏ –Ω–∞ /support/{ticketId} ‚Üí internal notes –Ω–µ –≤–∏–¥–Ω—ã.

---

## P1/P2 (UI) ‚Äî —É–±—Ä–∞—Ç—å –∫–ª–∏–ø —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ TicketCard
–§–∞–π–ª: src/components/support/TicketCard.tsx
–°–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—É—Å-–±–µ–π–¥–∂ –ù–ï –∫–æ–Ω–∫—É—Ä–∏—Ä–æ–≤–∞–ª –ø–æ —à–∏—Ä–∏–Ω–µ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º:
- –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å layout: –±–µ–π–¥–∂ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É (–Ω–∏–∂–µ subject) –∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é ‚Äú–∫–æ–ª–æ–Ω–∫—É‚Äù —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –º–µ—Å—Ç–æ–º.
- Unread-dot –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –∞–≤–∞—Ç–∞—Ä–µ (–Ω–µ absolute –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –∫–∞—Ä—Ç–æ—á–∫–∏).
DoD:
- –ù–∞ —à–∏—Ä–∏–Ω–µ –ø–∞–Ω–µ–ª–∏ 15%‚Äì40% –±–µ–π–¥–∂ –≤—Å–µ–≥–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–∏–º.
- –¢–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç—Ä—é–Ω–∫–µ–π—Ç–∏—Ç—Å—è, –∞ –Ω–µ –±–µ–π–¥–∂.
- Open/Closed –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–æ paddings/–≤—ã—Å–æ—Ç–µ/–≥—É—Ç—Ç–µ—Ä–∞–º.

(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) TicketStatusBadge compact-–ª–µ–π–±–ª—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.

---

## P2 (CLIENT NOTIFICATIONS) ‚Äî –±–µ–π–¥–∂ ‚Äú–Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–æ‚Äù –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é –∫–ª–∏–µ–Ω—Ç–∞
–§–∞–π–ª: –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∞–π–¥–±–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–π—Ç–∏ —Ä–µ–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª: AppSidebar.tsx/Sidebar.tsx/‚Ä¶)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å useUnreadTicketsCount (client, has_unread_user).
- –ü–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Å–Ω—É—é —Ç–æ—á–∫—É –∏–ª–∏ count —Ä—è–¥–æ–º —Å ‚Äú–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞‚Äù –ø—Ä–∏ count > 0.
- –î–æ–±–∞–≤–∏—Ç—å realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ count –±–µ–∑ refresh:
  - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ support_tickets (–∏–ª–∏ ticket_messages) –ø–æ —Ç–µ–∫—É—â–µ–º—É user_id
  - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π cleanup –∫–∞–Ω–∞–ª–∞ –ø—Ä–∏ unmount
DoD:
- –ê–¥–º–∏–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –≤ —Ç–∏–∫–µ—Ç–µ ‚Üí —É –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –º–µ–Ω—é.
- –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ç–∏–∫–µ—Ç ‚Üí –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏—Å—á–µ–∑–∞–µ—Ç.

---

## P2.1 (READ/UNREAD)
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ç–∏–∫–µ—Ç–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è markRead –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è has_unread_user=false.
–ö–æ–¥ –º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.
DoD: –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–∏–∫–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º count=0.

---

## P2.2 (REACTIONS) ‚Äî —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
### –ú–∏–≥—Ä–∞—Ü–∏—è (–í–ê–ñ–ù–û: –±–µ–∑ DEFAULT auth.uid())
–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É:
- ticket_message_reactions(
  id uuid PK default gen_random_uuid(),
  message_id uuid NOT NULL references ticket_messages(id) on delete cascade,
  user_id uuid NOT NULL,
  emoji text NOT NULL,
  created_at timestamptz default now(),
  UNIQUE(message_id, user_id, emoji)
)
–ò–Ω–¥–µ–∫—Å: (message_id)

RLS:
- SELECT: —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ç–µ–º, –∫—Ç–æ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–æ–æ–±—â–µ–Ω–∏—é/—Ç–∏–∫–µ—Ç—É (–≤–ª–∞–¥–µ–ª–µ—Ü —Ç–∏–∫–µ—Ç–∞) + –∞–¥–º–∏–Ω—ã.
- INSERT: WITH CHECK (user_id = auth.uid()).
- DELETE: USING (user_id = auth.uid()).
–î–æ–±–∞–≤–∏—Ç—å –≤ supabase_realtime publication.

### UI/—Ö—É–∫–∏
–ù–æ–≤—ã–π —Ö—É–∫: src/hooks/useTicketReactions.ts
- bulk fetch —Ä–µ–∞–∫—Ü–∏–π –ø–æ message_ids
- toggle reaction (insert/delete)
- realtime –Ω–∞ reactions

–§–∞–π–ª: src/components/support/TicketMessage.tsx
- –ü–æ–∫–∞–∑ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π (emoji + count)
- –ë—ã—Å—Ç—Ä—ã–µ emoji (üëç‚ù§Ô∏èüòÇüòÆüò¢üëé) + ‚Äú–µ—â—ë‚Äù
- –ö–ª–∏–∫ –ø–æ —Å–≤–æ–µ–π —Ä–µ–∞–∫—Ü–∏–∏ —É–±–∏—Ä–∞–µ—Ç

DoD:
- –ö–ª–∏–µ–Ω—Ç –∏ –∞–¥–º–∏–Ω –≤–∏–¥—è—Ç —Ä–µ–∞–∫—Ü–∏–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ.
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ –ø–æ —Ä–µ–∞–∫—Ü–∏–∏ toggles.
- –†–µ–∞–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è realtime –±–µ–∑ refresh.

---

## P0/P2 (TELEGRAM BRIDGE) ‚Äî –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –º–æ—Å—Ç Support ‚Üî Telegram
### –ú–∏–≥—Ä–∞—Ü–∏—è
support_tickets:
- telegram_bridge_enabled boolean default false
- telegram_user_id bigint null

ticket_telegram_sync:
- ticket_id uuid NOT NULL FK support_tickets
- ticket_message_id uuid FK ticket_messages
- telegram_message_id bigint
- direction ('to_telegram'|'from_telegram')
- created_at
- UNIQUE(ticket_message_id, direction)
RLS: admin/superadmin only.

### Edge Functions (add-only)
1) telegram-admin-chat: action bridge_ticket_message
- Guards: bridge_enabled=true, telegram_user_id not null
- Idempotency: –µ—Å–ª–∏ sync —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ —Å–ª–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
- –ù–ò–ö–û–ì–î–ê –Ω–µ —Å–ª–∞—Ç—å internal notes
- –õ–æ–≥ –≤ audit_logs (actor_type='system', actor_user_id=null)

2) telegram-webhook:
- –≤—Ö–æ–¥—è—â–µ–µ TG —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –Ω–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–π bridged ticket –ø–æ telegram_user_id
- —Å–æ–∑–¥–∞—Ç—å ticket_message author_type='user'
- –∑–∞–ø–∏—Å–∞—Ç—å ticket_telegram_sync direction='from_telegram'
- –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å internal

### UI
Admin TicketChat:
- —á–µ–∫–±–æ–∫—Å ‚Äú–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram‚Äù (—Ç–æ–ª—å–∫–æ isAdmin=true –∏ –µ—Å—Ç—å telegram_user_id)
- –ø–æ—Å–ª–µ insert —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí –≤—ã–∑–æ–≤ bridge_ticket_message

DoD:
- Admin UI ‚Üí TG –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ (1 —Ä–∞–∑, –±–µ–∑ –¥—É–±–ª–µ–π).
- TG ‚Üí ticket_messages –ø–æ—è–≤–∏–ª–æ—Å—å –≤ —Ç–∏–∫–µ—Ç–µ.
- internal notes –Ω–µ —É—Ö–æ–¥—è—Ç –≤ TG –Ω–∏–∫–æ–≥–¥–∞.

---

## –§–∏–Ω–∞–ª—å–Ω—ã–π DoD (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
1) Badge –Ω–µ –∫–ª–∏–ø–∞–µ—Ç—Å—è –ø—Ä–∏ 15‚Äì40% —à–∏—Ä–∏–Ω–µ –ø–∞–Ω–µ–ª–∏.
2) –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ –µ—Å—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –≤ –º–µ–Ω—é –∏ –æ–Ω –∏—Å—á–µ–∑–∞–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–∏–∫–µ—Ç–∞.
3) –†–µ–∞–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç (insert/delete, count, realtime).
4) TG bridge —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã, –±–µ–∑ –¥—É–±–ª–µ–π, –±–µ–∑ internal notes.
5) –ü—Ä—É—Ñ—ã: —Å–∫—Ä–∏–Ω—ã UI + SQL select‚Äô—ã + –ª–æ–≥–∏ edge/audit.