

# Ограничение уведомлений «Карта не привязана» до 7, 3 и 1 дня

## Проблема

Сейчас блок «NO-CARD WARNING» в `subscription-renewal-reminders/index.ts` (строки 966-1042) выбирает все подписки без карты с `access_end_at` в пределах 7 дней и отправляет уведомление **каждый день**. Единственная защита — `wasReminderSentToday` (не отправлять дважды за один день). В итоге пользователь получает 7 одинаковых сообщений подряд.

## Решение

Добавить фильтр по количеству оставшихся дней: отправлять уведомление «Карта не привязана» **только** когда `daysLeft` равно 7, 3 или 1. Во все остальные дни — пропускать.

## Техническая реализация

### Файл: `supabase/functions/subscription-renewal-reminders/index.ts`

В цикле обработки `noCardSubs` (после строки 1008, где вычисляется `daysLeft`) добавить проверку:

```typescript
// Отправляем предупреждение только за 7, 3 и 1 день
const noCardReminderDays = [7, 3, 1];
if (!noCardReminderDays.includes(daysLeft)) {
  console.log(`No-card warning skipped for user ${userId}: daysLeft=${daysLeft} not in [7,3,1]`);
  continue;
}
```

Эта проверка вставляется сразу после строки 1008 (`const daysLeft = ...`) и перед строкой 1010 (`const telegramResult = ...`).

### После изменений

Передеплоить edge-функцию `subscription-renewal-reminders`.

## Результат

Пользователь без привязанной карты получит максимум 3 уведомления: за 7, за 3 и за 1 день до окончания подписки — ровно как обычные напоминания об истечении.

