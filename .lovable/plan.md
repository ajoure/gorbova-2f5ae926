
# –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π —Å –í—ã–ø–∏—Å–∫–æ–π bePaid

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. Origin Filter ‚Äî –∑–∞–ø–∏—Å–∏ –Ω–µ –≤–∏–¥–Ω—ã –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
**–°–∏–º–ø—Ç–æ–º:** 221 –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ (audit_log: errors=221)
**–ü—Ä–∏—á–∏–Ω–∞:** Edge Function —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å–∏ —Å `origin='statement_sync'`, –Ω–æ UI —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ `origin='bepaid'`

**–í–ª–∏—è–Ω–∏–µ:**
- –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ë–î, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥—É–º–∞–µ—Ç, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å

### 2. –°—á—ë—Ç—á–∏–∫ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (571 vs 682)
**–§–æ—Ä–º—É–ª–∞:** 458 (payments_v2) + 113 (queue) = 571
**–í –≤—ã–ø–∏—Å–∫–µ:** 682
**–†–∞–∑–Ω–∏—Ü–∞:** 111 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö

### 3. –ü—Ä–∏–º–µ—Ä –ê–Ω–∞–Ω–µ–≤–∏—á –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–ª–∞—Ç—ë–∂ –æ—Ç 27.12.2025 (–≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ 01.01-26.01.2026)
**–°—Ç–∞—Ç—É—Å:** Payment.provider_payment_id = NULL ‚Üí –Ω–µ –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω –ø–æ UID

---

## –†–µ—à–µ–Ω–∏–µ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å origin –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** `origin: 'statement_sync'` –Ω–µ –≤–∏–¥–µ–Ω –≤ UI

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
1. **–ó–∞–ø–∏—Å—ã–≤–∞—Ç—å `origin: 'bepaid'`** ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã, –Ω–æ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è trace
2. **–î–æ–±–∞–≤–∏—Ç—å `origin: 'statement_sync'` –≤ —Ñ–∏–ª—å—Ç—Ä UI** ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è trace

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç 2 (—Å–æ—Ö—Ä–∞–Ω—è–µ–º trace)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

**useUnifiedPayments.tsx (—Å—Ç—Ä–æ–∫–∞ 188-192):**
```typescript
// –ë—ã–ª–æ:
if (includeImport) {
  query = query.in("origin", ["bepaid", "import"]);
} else {
  query = query.eq("origin", "bepaid");
}

// –°—Ç–∞–Ω–µ—Ç:
if (includeImport) {
  query = query.in("origin", ["bepaid", "import", "statement_sync"]);
} else {
  query = query.in("origin", ["bepaid", "statement_sync"]);
}
```

---

## –†–µ—à–µ–Ω–∏–µ 2: –û–±–Ω–æ–≤–∏—Ç—å RPC get_payments_stats

**–§–∞–π–ª:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (RPC —Ñ—É–Ω–∫—Ü–∏—è)

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å `origin='statement_sync'` –≤ —É—Å–ª–æ–≤–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

```sql
-- –ë—ã–ª–æ:
AND p.origin = 'bepaid'

-- –°—Ç–∞–Ω–µ—Ç:
AND p.origin IN ('bepaid', 'statement_sync')
```

---

## –†–µ—à–µ–Ω–∏–µ 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ Edge Function

**–ü—Ä–æ–±–ª–µ–º–∞:** 221 –æ—à–∏–±–æ–∫ –Ω–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã ‚Äî –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ sync-payments-with-statement/index.ts:**

1. –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –æ—à–∏–±–æ–∫:
```typescript
if (insertError) {
  console.error(`[sync-statement] Error creating payment ${change.uid}:`, insertError);
  stats.errors++;
  // –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–∫–∏
  stats.error_details = stats.error_details || [];
  stats.error_details.push({
    uid: change.uid,
    action: 'create',
    error: insertError.message,
  });
}
```

2. –í–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫–∏ –≤ response –¥–ª—è UI:
```typescript
// –í SyncStats interface
error_details?: Array<{ uid: string; action: string; error: string }>;
```

---

## –†–µ—à–µ–Ω–∏–µ 4: –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ UI

**–§–∞–π–ª:** SyncWithStatementDialog.tsx

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–ª–æ–∫ —Å –æ—à–∏–±–∫–∞–º–∏:
```tsx
{stats?.errors > 0 && (
  <div className="rounded-lg bg-destructive/10 border border-destructive/20 p-3">
    <div className="flex items-center gap-2 text-destructive mb-2">
      <AlertTriangle className="h-4 w-4" />
      <span className="font-medium">–û—à–∏–±–∫–∏: {stats.errors}</span>
    </div>
    {stats.error_details?.slice(0, 10).map((e, i) => (
      <div key={i} className="text-xs text-muted-foreground">
        {e.uid}: {e.error}
      </div>
    ))}
  </div>
)}
```

---

## –†–µ—à–µ–Ω–∏–µ 5: –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –ê–Ω–∞–Ω–µ–≤–∏—á

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–ª–∞—Ç—ë–∂ –æ—Ç 27.12.2025 –∏–º–µ–µ—Ç `provider_payment_id = NULL`, –ø–æ—ç—Ç–æ–º—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –µ–≥–æ –ø–æ UID

**–û–ø—Ü–∏–∏:**
1. –†–∞—Å—à–∏—Ä–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞ –¥–µ–∫–∞–±—Ä—å 2025
2. –†—É—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ UI (–∫–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–¥–µ–ª–∫–∏)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–ª—è –¥–µ–∫–∞–±—Ä—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å –¥–∞—Ç–∞–º–∏ 01.12.2025 - 31.12.2025

---

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. ‚úèÔ∏è **useUnifiedPayments.tsx** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `statement_sync` –≤ origin filter
2. ‚úèÔ∏è **get_payments_stats RPC** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `statement_sync` –≤ —É—Å–ª–æ–≤–∏–µ
3. ‚úèÔ∏è **Edge Function** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –æ—à–∏–±–æ–∫
4. ‚úèÔ∏è **SyncWithStatementDialog.tsx** ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ UI
5. üöÄ –î–µ–ø–ª–æ–π Edge Function
6. üß™ –¢–µ—Å—Ç: –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

| –ò—Å—Ç–æ—á–Ω–∏–∫ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | Origin |
|----------|-----------|--------|
| bepaid_statement_rows | 682 | ‚Äî |
| payments_v2 (origin=bepaid) | 458 | bepaid |
| payments_v2 (origin=statement_sync) | ? | statement_sync |
| payment_reconcile_queue | 113 | ‚Äî |
| **UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç** | 571 | bepaid only |

### –§–æ—Ä–º—É–ª–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞:
- UI –ø–æ–∫–∞–∂–µ—Ç: 458 + X (statement_sync) + 113 (queue) = –±–ª–∏–∂–µ –∫ 682
- –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ –≤—ã–ø–∏—Å–∫–∏ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã

---

## DoD (Definition of Done)

- [ ] –ó–∞–ø–∏—Å–∏ —Å `origin='statement_sync'` –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ UI
- [ ] RPC get_payments_stats —É—á–∏—Ç—ã–≤–∞–µ—Ç statement_sync
- [ ] –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫
- [ ] –°—á—ë—Ç—á–∏–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—ã–ø–∏—Å–∫–µ (682)
- [ ] –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∑–∞ –¥–µ–∫–∞–±—Ä—å 2025 –¥–ª—è –ê–Ω–∞–Ω–µ–≤–∏—á
