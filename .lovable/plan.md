
# План: Реорганизация страницы Сделок

## Обзор задач

1. **Добавить лёгкий фильтр по продуктам** — быстрые кнопки-пиллы для фильтрации по продуктам
2. **Убрать стат-панель (DealsStatsBar)** — плашка с "Всего, Оплачено, Ожидает, Выручка"
3. **Убрать кнопку "Импорт"** — удалить из UI
4. **Показывать только оплаченные сделки** — убрать из таблицы/карточек сделки со статусом pending/failed

---

## Детали изменений

### 1. Фильтр по продуктам — быстрые пиллы

Добавлю под существующими табами (Все, Оплачены, Ожидают...) ряд кнопок-пиллов для фильтрации по продуктам в нашем glassmorphism-стиле:

```
┌─────────────────────────────────────────────────────────────┐
│  Все │ Оплачены │ Ожидают │ Триал │ Отменённые │ Импорт    │  ← существующие табы
├─────────────────────────────────────────────────────────────┤
│  Gorbova Club │ Бухгалтерия как бизнес │ ...                │  ← НОВЫЙ фильтр по продуктам
└─────────────────────────────────────────────────────────────┘
```

**Реализация:**
- Добавить `selectedProductId` state
- Вывести список активных продуктов как pill-кнопки
- При клике на продукт — фильтровать `filteredDeals` по `product_id`
- Добавить кнопку "Все продукты" для сброса фильтра

---

### 2. Убрать DealsStatsBar

Удалить компонент `<DealsStatsBar ... />` из рендера (строки 639-646).

Также можно удалить связанные:
- `stats` useMemo (строки 299-311)
- `handleStatClick` callback (строки 314-329)
- `healthStats` и `autoPaymentStats` queries (строки 209-252)

---

### 3. Убрать кнопку "Импорт"

Удалить кнопку "Импорт" из UI (строки 624-627):
```tsx
<Button variant="outline" size="sm" className="h-8" onClick={() => setShowImportWizard(true)}>
  <Sparkles className="h-3.5 w-3.5 sm:mr-1.5" />
  <span className="hidden sm:inline">Импорт</span>
</Button>
```

Также удалить:
- `showImportWizard` state
- `<SmartImportWizard ... />` компонент (строки 872-876)

---

### 4. Показывать только оплаченные сделки

**Главная страница сделок (`AdminDeals.tsx`):**
- Добавить базовый фильтр в запрос: `.eq("status", "paid")`
- Или фильтровать на клиенте в `filteredDeals`
- Убрать пресеты "Ожидают оплаты" и статусы pending/failed из UI

**Карточка контакта (`ContactDetailSheet.tsx`):**
- Фильтровать `deals` в запросе или при рендере: показывать только `status === "paid"`
- Вкладка "Сделки" показывает только оплаченные
- Вкладка "Платежи" показывает все платежи (включая failed/pending)

---

## Технические изменения

### Файл: `src/pages/admin/AdminDeals.tsx`

| Строки | Действие | Описание |
|--------|----------|----------|
| 79 | Добавить | `const [selectedProductId, setSelectedProductId] = useState<string \| null>(null);` |
| 91-117 | Изменить | Добавить `.eq("status", "paid")` в запрос или фильтр на клиенте |
| 209-252 | Удалить | `healthStats` и `autoPaymentStats` queries |
| 299-329 | Удалить | `stats` useMemo и `handleStatClick` callback |
| 351-358 | Изменить | Убрать пресеты "Ожидают оплаты" — оставить только: Все, Триал, Отменённые, Импортированные |
| 580-607 | После | Добавить pill-фильтры по продуктам |
| 624-627 | Удалить | Кнопка "Импорт" |
| 639-646 | Удалить | `<DealsStatsBar ... />` |
| 83, 872-876 | Удалить | `showImportWizard` state и `<SmartImportWizard />` |

### Файл: `src/components/admin/ContactDetailSheet.tsx`

| Строки | Действие | Описание |
|--------|----------|----------|
| 371-398 | Изменить | В запросе сделок добавить `.eq("status", "paid")` |
| 2433 | Убрать | Проверка `isPaid` уже не нужна — все сделки будут оплаченные |

---

## Визуальный результат

### До:
```
┌──────────────────────────────────────────────────────────────────┐
│ Все │ Оплачены 99+ │ Ожидают оплаты 3 │ Триал │ Отменённые │ ... │
├──────────────────────────────────────────────────────────────────┤
│ [📅 Все периоды]  [✨ Импорт]  [🔄]                               │
├──────────────────────────────────────────────────────────────────┤
│ 📦424 │ ✅358 │ ⏳3 │ 📈63 623 Br │ ... │ ⚠️54 Под угрозой       │
├──────────────────────────────────────────────────────────────────┤
│ 🔍 Поиск...                                                      │
└──────────────────────────────────────────────────────────────────┘
```

### После:
```
┌──────────────────────────────────────────────────────────────────┐
│ Все │ Триал 35 │ Отменённые 19 │ Импортированные                 │
├──────────────────────────────────────────────────────────────────┤
│ 🏷️ Все продукты │ Gorbova Club │ Бухгалтерия как бизнес │ ...    │  ← НОВОЕ
├──────────────────────────────────────────────────────────────────┤
│ [📅 Все периоды]  [🔄]                                            │
├──────────────────────────────────────────────────────────────────┤
│ 🔍 Поиск...                                                      │
└──────────────────────────────────────────────────────────────────┘
```

---

## Примечание о бизнес-логике

**Сделка = успешная оплата.** Записи со статусами `pending`, `failed`, `draft` — это платежи, не сделки.

- `status = "paid"` → Сделка
- `status = "trial"` → Сделка (триальная)
- `status = "cancelled"` / `"refunded"` → Отменённая сделка (но была оплачена)
- `status = "pending"` / `"failed"` / `"draft"` → **НЕ сделка**, это платёжные попытки

Соответственно:
- Меню "Сделки" → только paid, trial, cancelled, refunded
- Меню "Платежи" → все транзакции включая failed/pending
