
# План: Шаблоны и запланированные рассылки

## Анализ текущей системы

### Существующая инфраструктура:
- **`BroadcastsTabContent.tsx`** — UI для отправки Telegram и Email рассылок
- **`email_templates`** — таблица для email-шаблонов (уже существует)
- **`audit_logs`** — хранит историю отправленных рассылок
- **`telegram_logs`** — хранит детали сообщений

### Чего не хватает:
1. Таблица для **шаблонов Telegram-рассылок**
2. UI для управления шаблонами (создание, редактирование, удаление)
3. Возможность отправки из готового шаблона
4. Перенос отправленных шаблонов в архив

---

## Техническое решение

### 1. Новая таблица `broadcast_templates`

```sql
CREATE TABLE public.broadcast_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,                    -- Название шаблона
  channel TEXT NOT NULL DEFAULT 'telegram', -- 'telegram' | 'email'
  
  -- Telegram fields
  message_text TEXT,
  button_text TEXT,
  button_url TEXT,
  
  -- Email fields  
  email_subject TEXT,
  email_body_html TEXT,
  
  -- Status
  status TEXT NOT NULL DEFAULT 'draft',  -- 'draft' | 'scheduled' | 'sent' | 'archived'
  scheduled_for TIMESTAMPTZ,              -- Для запланированных
  
  -- Stats (after sending)
  sent_count INT DEFAULT 0,
  failed_count INT DEFAULT 0,
  sent_at TIMESTAMPTZ,
  
  -- Meta
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- RLS
ALTER TABLE broadcast_templates ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Admins can manage templates" ON broadcast_templates
  FOR ALL TO authenticated
  USING (has_permission(auth.uid(), 'entitlements.manage'));
```

### 2. Изменения в UI (`BroadcastsTabContent.tsx`)

#### Новые секции:

**A) Список шаблонов (вместо пустой формы)**
- Карточки с готовыми шаблонами
- Кнопки: «Редактировать», «Отправить», «В архив»
- Фильтр по статусу: Черновики | Запланированные | Архив

**B) Форма создания/редактирования шаблона**
- При клике «+ Создать шаблон» открывается модалка
- Все поля как сейчас + название шаблона
- Кнопки: «Сохранить как черновик» | «Отправить сейчас»

**C) Шаблон "Анонс Базы знаний"**
- Предустановленный шаблон с утверждённым текстом
- Telegram + Email версии

---

## Структура UI

```text
┌─────────────────────────────────────────────────────────────┐
│  📋 Шаблоны рассылок                    [+ Создать шаблон] │
├─────────────────────────────────────────────────────────────┤
│  [Черновики] [Запланированные] [Архив]                      │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────┐     │
│  │ 📢 Анонс Базы знаний                               │     │
│  │ Telegram • Создан: 30 янв 2026                     │     │
│  │ "База знаний открыта! Мы запустили..."            │     │
│  │                                                    │     │
│  │ [Редактировать] [📤 Отправить] [В архив]          │     │
│  └────────────────────────────────────────────────────┘     │
│                                                             │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 📧 Email: Анонс Базы знаний                        │     │
│  │ Email • Создан: 30 янв 2026                        │     │
│  │ Тема: "🎉 Открыта База знаний..."                  │     │
│  │                                                    │     │
│  │ [Редактировать] [📤 Отправить] [В архив]          │     │
│  └────────────────────────────────────────────────────┘     │
├─────────────────────────────────────────────────────────────┤
│  📜 История отправок                                        │
│  (отправленные рассылки с результатами)                    │
└─────────────────────────────────────────────────────────────┘
```

---

## Изменяемые файлы

| Файл | Изменения |
|------|-----------|
| SQL миграция | Создать таблицу `broadcast_templates` с RLS |
| `src/components/admin/communication/BroadcastsTabContent.tsx` | Рефакторинг: добавить управление шаблонами, разделить на секции |
| Новый: `src/components/admin/communication/BroadcastTemplateCard.tsx` | Карточка шаблона |
| Новый: `src/components/admin/communication/BroadcastTemplateDialog.tsx` | Диалог создания/редактирования |

---

## Предустановленные шаблоны

После миграции будут созданы 2 шаблона:

**1. Telegram — Анонс Базы знаний**
```
🎉 База знаний открыта!

Мы запустили новый публичный раздел на сайте — Базу знаний с ответами на реальные вопросы от Катерины Горбовой.

📚 Что уже доступно:
• более 670 вопросов и ответов
• 100 видеоэфиров с подробными разборами
• налоги, документы, клиенты, договоры
• практические ситуации из реальной работы

Все материалы удобно структурированы — можно быстро найти нужный ответ.

👉 Участникам Клуба с тарифами FULL и BUSINESS открыт полный доступ к видео.
👀 Остальные могут посмотреть вопросы и оценить ценность базы.
```
- Кнопка: «Открыть Базу знаний»
- URL: `https://club.gorbova.by/knowledge`

**2. Email — Анонс Базы знаний**
- Тема: `🎉 Открыта База знаний — 670+ вопросов и 100 видеоэфиров`
- HTML из утверждённого плана

---

## Логика отправки

1. Выбрать шаблон из списка
2. Нажать «Отправить»
3. Открывается попап с:
   - Превью сообщения
   - Фильтры аудитории (справа, как сейчас)
   - Кнопка подтверждения
4. После отправки:
   - Шаблон обновляется: `status = 'sent'`, `sent_at`, `sent_count`, `failed_count`
   - Можно повторно отправить или архивировать

---

## Ожидаемый результат

После реализации:
- В разделе «Рассылки» появится список шаблонов
- Готовые шаблоны для анонса Базы знаний (Telegram + Email)
- Кнопка «Отправить» откроет попап с выбором аудитории
- После отправки — шаблон можно архивировать
- История отправок сохраняется внизу страницы
