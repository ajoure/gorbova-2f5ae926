
# Две функции для страницы «Редакция»

## 1. Автоматический парсинг по расписанию (Настройки)

### Что будет
В настройках (вкладка «Настройки») появится новая карточка **«Расписание парсинга»** с:
- Переключатель ВКЛ/ВЫКЛ автоматического парсинга
- Два слота времени (по умолчанию **08:00** и **15:00** по Минску)
- Возможность изменить время через удобные селекторы
- Кнопка «Сохранить» для применения расписания

### Как это работает
- Настройки (enabled + два времени) хранятся в таблице `app_settings` (ключ `news_auto_scrape_schedule`)
- При сохранении вызывается SQL-запрос, который создаёт/обновляет/удаляет `cron.job` записи для `monitor-news`
- Cron будет вызывать `monitor-news` через `net.http_post` (аналогично другим существующим cron-задачам)
- Время Минска (UTC+3) пересчитывается в UTC для cron-выражений (08:00 MSK = 05:00 UTC, 15:00 MSK = 12:00 UTC)

### Техническая реализация

**База данных (миграция):**
- Вставить начальную настройку в `app_settings`:
  ```sql
  INSERT INTO app_settings (key, value) VALUES (
    'news_auto_scrape_schedule',
    '{"enabled": true, "slots": ["08:00", "15:00"], "timezone": "Europe/Minsk"}'
  ) ON CONFLICT (key) DO NOTHING;
  ```
- Создать 2 cron-задачи:
  ```sql
  SELECT cron.schedule('monitor-news-morning', '0 5 * * *', $$ ... net.http_post monitor-news ... $$);
  SELECT cron.schedule('monitor-news-afternoon', '0 12 * * *', $$ ... net.http_post monitor-news ... $$);
  ```

**Edge Function (новая): `manage-news-schedule`**
- Принимает `{ enabled, slots }` от UI
- Пересчитывает время MSK в UTC
- Выполняет `cron.unschedule` + `cron.schedule` через SQL
- Обновляет `app_settings`

**UI (AdminEditorial.tsx):**
- Новая карточка в секции настроек (перед карточкой «ИИ-стиль»)
- Иконка `Clock`, заголовок «Расписание парсинга»
- Switch для вкл/выкл
- Два поля ввода времени (type="time") с метками «Утро» и «День»
- Индикатор текущего статуса: «Следующий запуск: сегодня в 15:00»

---

## 2. Массовая публикация новостей (вкладка «Входящие»)

### Что будет
На вкладке «Входящие» появится:
- Чекбокс на каждой карточке новости для выделения
- Плавающая панель внизу (при выделении хотя бы 1 новости):
  - Счётчик «Выбрано: N»
  - Кнопка «Опубликовать выбранные»
  - Кнопка «Снять выделение»
- Публикация идёт последовательно (по одной), с прогрессом

### Техническая реализация

**UI (AdminEditorial.tsx):**
- Новый state: `selectedDraftIds: Set<string>`
- Чекбокс в `renderNewsCard` (когда вкладка = drafts и showActions = true)
- «Выбрать все» чекбокс в шапке вкладки
- Плавающая панель действий при `selectedDraftIds.size > 0`
- Мутация `batchPublishMutation`: итерирует по выбранным ID, для каждого вызывает `publishMutation.mutateAsync`, показывает прогресс toast
- После завершения: очистка выделения, invalidate queries

**Логика публикации:**
- Каждая новость публикуется на сайт (`is_published = true`) + в Telegram (если канал настроен)
- Последовательно, с задержкой ~500ms между публикациями (чтобы не перегрузить Telegram API)
- Прогресс: toast с обновлением `Опубликовано 3 из 7...`

---

## Затрагиваемые файлы

| Файл | Изменение |
|------|-----------|
| `src/pages/admin/AdminEditorial.tsx` | Карточка расписания в настройках + чекбоксы и панель массовой публикации во «Входящих» |
| `supabase/functions/manage-news-schedule/index.ts` | **Новый** -- edge function для управления cron-расписанием |
| Миграция SQL | Создание cron-задач + запись в `app_settings` |
