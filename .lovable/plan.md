План:

## Что происходит и почему “починка как вчера” снова нужна

Проблема воспроизводится **в редакторе lovable.dev на iPhone (iOS Safari)** и выглядит как постоянный краш/перезагрузка вкладки.

Корневая причина (подтверждённая, повторяется):
- iOS Safari имеет жёсткие лимиты по памяти.
- lovable.dev — тяжёлая страница (редактор + чат + iframe-превью).
- В превью автоматически открывается **тяжёлый маршрут приложения** (чаще всего `/admin/*`, особенно после импорта Excel).
- У вас включено восстановление **последнего маршрута (lastRoute)**.
- Если последний маршрут — админка, iOS пытается загрузить её сразу → память переполняется → вкладка перезагружается.
- Вчера это уже фиксили, но **после добавления Excel-парсера снова появился маршрут, который сохраняется и восстанавливается**.

Цель:  
**Гарантированно запретить автозагрузку тяжёлых маршрутов в превью на iOS**, даже если код снова начнёт сохранять lastRoute.

---

## Что именно делаем (исправленный и усиленный план)

### 1) iOS-guard при СОХРАНЕНИИ lastRoute (как вчера, но жёстче)

Файл:
- `src/hooks/useLastRoute.ts`

Изменения:
- Определяем iOS Safari:
  - `/iP(hone|ad|od)/.test(navigator.userAgent)`
- **На iOS Safari НЕ сохраняем lastRoute**, если:
  - маршрут начинается с `/admin`
  - маршрут содержит:
    - `/admin/kb-import`
    - `/admin/broadcast`
    - `/admin/communication`
    - любые страницы импорта/таблиц/рассылок
- Разрешаем сохранять только “лёгкие” маршруты:
  - `/dashboard`
  - `/knowledge`
  - `/library/*` (без админки)

Важно:  
Это именно **предохранитель** — даже если код где-то снова вызывает `saveLastRoute()`, на iOS тяжёлый маршрут просто не запишется.

---

### 2) iOS-guard при ВОССТАНОВЛЕНИИ lastRoute (вторая линия защиты)

Файл:
- `src/pages/Auth.tsx`

Изменения:
- При логине:
  - если устройство iOS Safari
  - и `lastRoute`:
    - начинается с `/admin`
    - или содержит ключевые слова админки/импорта
- Тогда:
  - **игнорируем lastRoute**
  - делаем redirect на `/dashboard`
  - **перезаписываем lastRoute = '/dashboard'**
    (чтобы не было бесконечных попыток восстановить админку при каждом входе)

Это повторяет вчерашнюю логику, но добавляет обязательную перезапись маршрута.

---

### 3) Глобальный safe-fallback для превью lovable.dev (НОВОЕ, чтобы больше не ловить этот баг)

Файл:
- `src/pages/Auth.tsx` или `src/App.tsx` (init-логика)

Изменения:
- Если:
  - обнаружен iOS Safari
  - приложение открыто **в iframe** (lovable.dev preview)
  - маршрут `/admin/*`
- Тогда:
  - немедленно `navigate('/dashboard', { replace: true })`
  - без ожидания login/restore

Это гарантирует:
- даже если lastRoute каким-то образом сохранился,
- даже если логика восстановления сломается,
- **превью на iOS никогда не загрузит админку автоматически**.

---

### 4) Обновить build marker (обязательная проверка)

Файл:
- `src/lib/externalLinkKillSwitch.ts`

Изменения:
- Обновить `BUILD_MARKER` (новый timestamp/patch-id).

Зачем:
- Вы сможете на iPhone однозначно увидеть, что:
  - загружена новая версия,
  - а не кэш/старая сборка.
- Без этого невозможно понять, “починили или не подгрузилось”.

---

## Как проверяем (без лишних слов)

### A) Desktop (контроль)
1. Зайти в админку.
2. Перейти по нескольким админ-страницам.
3. Разлогиниться → залогиниться.
4. lastRoute **восстанавливается**, как раньше.

### B) iPhone (главное)
1. Открыть lovable.dev → проект «Буква закона».
2. Вкладка **НЕ падает** при открытии.
3. Превью стартует с `/dashboard`, а не с `/admin`.
4. Повторный вход **не вызывает перезагрузку**.

---

## Риски и ограничения (честно)

- lovable.dev **в целом** плохо подходит для iPhone из-за памяти — это ограничение iOS.
- Мы не “лечим lovable.dev”, мы:
  - убираем самый частый триггер краша — автозагрузку админки.
- Если вручную на iPhone открыть тяжёлую админ-страницу — краш возможен (и это нормально).

---

## Критерии готовности (DoD)

1. lovable.dev на iPhone **перестаёт постоянно перезагружаться**.
2. `/admin/*` **никогда не открывается автоматически** в превью на iOS.
3. `BUILD_MARKER` обновлён и виден — подтверждение, что версия применена.
4. Поведение идентично “исправленному состоянию вчера”.

---

## Файлы для изменения (минимум, точно)

- `src/hooks/useLastRoute.ts` — запрет сохранения тяжёлых маршрутов на iOS
- `src/pages/Auth.tsx` — запрет восстановления `/admin` + принудительный fallback
- `src/lib/externalLinkKillSwitch.ts` — обновить `BUILD_MARKER`