
# Актуализация счётчиков ошибок на странице «Редакция»

## Проблема

На странице показано «3 ошибки», но фактически **5 источников** имеют `last_error_code = 408` (Минтруд, Минцифры, Минэкономразвития, ФАС, ФТС России). Расхождение вызвано двумя багами:

1. **`getHealthStatus()`** проверяет только `source.last_error` (текстовое поле), но НЕ проверяет `source.last_error_code`. У всех 5 проблемных источников `last_error = NULL`, а `last_error_code = '408'` — поэтому `healthStats.error` показывает 0 вместо 5.

2. **Баннер summary** берёт текст из `scrape_logs.summary`, где `sources_failed` считается только за один конкретный запуск (в последнем было 3), а не общее число источников с ошибками.

## Решение

### 1. Исправить `getHealthStatus()` (строка 194)

Добавить проверку `last_error_code` наряду с `last_error`:

```text
if (source.last_error || source.last_error_code) {
  return { status: "error", icon: "...", label: "Ошибка", color: "..." };
}
```

Это исправит:
- Счётчик `healthStats.error` (красная карточка «Ошибки» на вкладке Настройки)
- Бейдж на табе «Настройки»
- Кнопку «Повторить для ошибок»
- Иконку статуса в таблице источников

### 2. Уточнить баннер summary (строка 1138-1157)

Вместо вывода только `lastScrapeLog.summary` — добавить под ним актуальный счётчик ошибок из `healthStats`:

```text
Найдено 11 новостей из 22 источников (3 ошибки в запуске)
Текущих проблемных источников: 5   <-- дополнительная строка
```

Если `healthStats.error > sources_failed` из лога — показать предупреждение, что реальных ошибок больше.

### 3. Добавить `408` в `getErrorLabel()` (строка 112)

Сейчас код 408 попадает в `default` и показывает «Ошибка: 408». Добавить явный case:

```text
case "408":
  return { label: "Таймаут запроса", emoji: "⏱" };
```

## Затрагиваемые файлы

| Файл | Изменение |
|------|-----------|
| `src/pages/admin/AdminEditorial.tsx` | 3 точечных правки: `getHealthStatus`, `getErrorLabel`, баннер summary |

Никакие другие файлы не затрагиваются.
