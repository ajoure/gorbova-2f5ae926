# PATCH: –î–µ–º–æ–Ω—Ç–∞–∂ MIT-–¥–∞–≤–ª–µ–Ω–∏—è –≤ UX + –∑–∞–º–µ–Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–∞ payment link + –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –∫–ª—é—á–µ–π

## –ü—Ä–∏–Ω—Ü–∏–ø

–ù–∏—á–µ–≥–æ –Ω–µ –ª–æ–º–∞–µ–º. MIT-—Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è, direct-charge, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã, subscription-charge ‚Äî –≤—Å–µ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –∫–æ–¥–µ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –±—ç–∫–µ–Ω–¥–µ. –ú–µ–Ω—è–µ–º **—Ç–æ–ª—å–∫–æ UI-–≤—ã–±–æ—Ä, —Ç–µ–∫—Å—Ç—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**. –ù–∏–∫–∞–∫–∏—Ö –Ω–æ–≤—ã—Ö Edge Functions –∏ —Ç–∞–±–ª–∏—Ü. –î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω –Ω–æ–≤—ã–π `_shared/*.ts` –º–æ–¥—É–ª—å.

---

## –ñ–µ—Å—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

- –ù–∏—á–µ–≥–æ –Ω–µ –ª–æ–º–∞—Ç—å –∏ –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å –ª–∏—à–Ω–µ–µ. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π diff.
- –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã—Ö Edge Functions/—Ç–∞–±–ª–∏—Ü.
- Extraction –≤ shared helper ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è `admin-create-payment-link` (—Ä–µ–≥—Ä–µ—Å—Å-–ø—Ä—É—Ñ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω).
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `direct-charge` –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º UI-—Ñ–ª–æ—É –æ–ø–ª–∞—Ç—ã (PaymentDialog).
- DoD —Ç–æ–ª—å–∫–æ –ø–æ —Ñ–∞–∫—Ç–∞–º: UI-—Å–∫—Ä–∏–Ω—ã (7500084@gmail.com) + –ø—Ä–∏–º–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å —Ä–∞–±–æ—á–∏–º–∏ `redirect_url` + –ø—Ä—É—Ñ, —á—Ç–æ –∞–¥–º–∏–Ω–∫–∞ —Å–æ–∑–¥–∞–µ—Ç link –∫–∞–∫ —Ä–∞–Ω—å—à–µ.

---

## –≠—Ç–∞–ø 1: Shared module –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è payment link

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `supabase/functions/_shared/create-payment-checkout.ts`

–ò–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ `admin-create-payment-link` core-–ª–æ–≥–∏–∫—É:
- –ü–æ–ª—É—á–µ–Ω–∏–µ bePaid credentials
- –ó–∞–≥—Ä—É–∑–∫–∞ product/tariff/profile
- –°–æ–∑–¥–∞–Ω–∏–µ order –≤ `orders_v2` (status: pending)
- –í—ã–∑–æ–≤ bePaid Checkout API / Subscriptions API
- –°–æ–∑–¥–∞–Ω–∏–µ `provider_subscriptions` –∑–∞–ø–∏—Å–∏ (–¥–ª—è subscription)
- –í–æ–∑–≤—Ä–∞—Ç `{ redirect_url, order_id, order_number }`

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π STOP-guard:** –µ—Å–ª–∏ product_id/tariff_id/amount –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ ‚Äî –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å orders_v2, —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—à–∏–±–∫—É / fallback –Ω–∞ `/purchases`.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```
{
  supabase, user_id, product_id, tariff_id, amount (kopecks),
  payment_type: 'one_time' | 'subscription',
  description?, offer_id?, origin?, actor_user_id?, actor_type?: 'admin' | 'system'
}
```

`admin-create-payment-link` —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—Å—è: auth/permission check –æ—Å—Ç–∞–µ—Ç—Å—è, core ‚Üí shared helper. –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ.

---

## –≠—Ç–∞–ø 2: PaymentDialog ‚Äî —É–±—Ä–∞—Ç—å MIT-–≤—ã–±–æ—Ä –∏ direct-charge

- –û—Å—Ç–∞–≤–∏—Ç—å —Ç–∏–ø `PaymentFlowType` –∏ state (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π diff), –Ω–æ default = `'provider_managed'`
- **–£–±—Ä–∞—Ç—å RadioGroup** MIT vs SBS (—Å—Ç—Ä–æ–∫–∏ 1131-1171)
- `shouldUseMitTokenization` –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ `false`
- **–£–±—Ä–∞—Ç—å –≤—ã–∑–æ–≤ direct-charge** –∏–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ UI (—Å—Ç—Ä–æ–∫–∏ 471-527) —Å guard-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º: `// CLIENT FLOW: never call direct-charge`
- –î–ª—è –ø–æ–¥–ø–∏—Å–æ–∫: –≤—Å–µ–≥–¥–∞ `provider_managed` (SBS checkout)
- –î–ª—è —Ä–∞–∑–æ–≤—ã—Ö: `bepaid-create-token` –±–µ–∑ `useMitTokenization`

---

## –≠—Ç–∞–ø 3: PaymentMethods ‚Äî —É–±—Ä–∞—Ç—å MIT-–¥–∞–≤–ª–µ–Ω–∏–µ

- –£–±—Ä–∞—Ç—å Alert "–í–∞—à–∞ —Ü–µ–Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞" (592-603)
- –£–±—Ä–∞—Ç—å Alert "–ü—Ä–∏–≤—è–∂–∏—Ç–µ –∫–∞—Ä—Ç—É –¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è" (607-625)
- –£–±—Ä–∞—Ç—å MIT-—á–∞—Å—Ç—å –±–ª–æ–∫–∞ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è (664-672)
- "–ö–∞—Ä—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π –∏ –±—ã—Å—Ç—Ä–æ–π –æ–ø–ª–∞—Ç—ã" ‚Üí "–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã"
- 3DS: "–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–π" ‚Üí "–û–ø–ª–∞—Ç–∞ —ç—Ç–æ–π –∫–∞—Ä—Ç–æ–π –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å 3D-Secure"
- –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É" –∏ `handleAddCard` ‚Äî **–æ—Å—Ç–∞—é—Ç—Å—è**

---

## –≠—Ç–∞–ø 4: subscription-renewal-reminders ‚Äî payment link

**–ü—Ä–∞–≤–∏–ª–æ:** payment link –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¢–û–õ–¨–ö–û –¥–ª—è !SBS. –î–ª—è SBS ‚Äî –º—è–≥–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ + `/purchases`.

### Telegram reminders
- –£–±—Ä–∞—Ç—å `hasCard`/`!hasCard` –≤–µ—Ç–≤–ª–µ–Ω–∏–µ
- –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π SBS –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É ‚Üí —Å–æ–∑–¥–∞—Ç—å payment link —á–µ—Ä–µ–∑ shared helper ‚Üí inline-–∫–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å –∏ –ø—Ä–æ–¥–ª–∏—Ç—å"
- –ï—Å–ª–∏ –µ—Å—Ç—å SBS ‚Üí "–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ" + CTA `/purchases`
- STOP-condition: –µ—Å–ª–∏ product_id/tariff_id/amount –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è ‚Üí fallback `/purchases` –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è order

### sendNoCardWarning ‚Üí sendExpiringWithPaymentLink
- –¢–∞ –∂–µ –ª–æ–≥–∏–∫–∞ SBS/!SBS —Å payment link

### Email reminders
- –£–±—Ä–∞—Ç—å `cardSection`, –µ–¥–∏–Ω—ã–π –±–ª–æ–∫ —Å CTA –Ω–∞ `redirect_url` –∏–ª–∏ fallback `/purchases`

### –¢–µ–∫—Å—Ç—ã

7 –¥–Ω–µ–π (–Ω–µ—Ç SBS):
```
üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ
{userName}, –≤–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ {productName} –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é ({date}).
–î–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –æ–ø–ª–∞—Ç–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ.
CTA: [–û–ø–ª–∞—Ç–∏—Ç—å –∏ –ø—Ä–æ–¥–ª–∏—Ç—å]({redirect_url})
```

7 –¥–Ω–µ–π (–µ—Å—Ç—å SBS):
```
üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ
{userName}, –≤–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ {productName} –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é ({date}).
–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
CTA: [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π](https://club.gorbova.by/purchases)
```

3 –¥–Ω—è / 1 –¥–µ–Ω—å ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –ø–∞—Ä—ã (–Ω–µ—Ç SBS / –µ—Å—Ç—å SBS).

---

## –≠—Ç–∞–ø 5: telegram-send-notification + buh-business-notify

- `legacy_card_notification` ‚Üí "–í–∞—à–∞ –∫–∞—Ä—Ç–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞. –î–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –æ–ø–ª–∞—Ç–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ" + `/purchases`
- `card_not_suitable_for_autopay` ‚Üí "–û–ø–ª–∞—Ç–∞ –≤–∞—à–µ–π –∫–∞—Ä—Ç–æ–π –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å 3D-Secure. –î–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è ‚Äî –æ–ø–ª–∞—Ç–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ" + `/purchases`
- `no_card` (buh-business-notify) ‚Üí "–°–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø. –î–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –æ–ø–ª–∞—Ç–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ" + `/purchases`

---

## –≠—Ç–∞–ø 6: –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –∫–ª—é—á–µ–π bePaid

- `useIntegrations.tsx`: `secret_key` type ‚Üí `password`
- `EditIntegrationDialog.tsx`: Eye/EyeOff toggle, `type="password"/"text"`, –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –ø—É—Å—Ç—ã–º

---

## –≠—Ç–∞–ø 7: –ö–æ—Å–º–µ—Ç–∏–∫–∞ –≤ –∞–¥–º–∏–Ω–∫–µ

- `ContactDetailSheet.tsx`: "–∫–∞—Ä—Ç–∞ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞" ‚Üí "–∫–∞—Ä—Ç–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞"
- `ContactPaymentsTab.tsx`: "–ü—Ä–∏–≤—è–∂–∏—Ç–µ –∫–∞—Ä—Ç—É" ‚Üí "–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π"
- `eventLabels.ts`: "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ—Ç –∫–∞—Ä—Ç—ã" ‚Üí "–ù–µ—Ç –∫–∞—Ä—Ç—ã (legacy)"
- `TelegramLogsSection.tsx`: label "–ù–µ—Ç –∫–∞—Ä—Ç—ã" ‚Üí "–ù–µ—Ç –∫–∞—Ä—Ç—ã (legacy)"

---

## –ß—Ç–æ –ù–ï —Ç—Ä–æ–≥–∞–µ–º

- `payment-methods-tokenize`, `direct-charge`, `bepaid-create-token`, `bepaid-create-subscription-checkout`, `subscription-charge`, `bepaid-webhook`
- –¢–∞–±–ª–∏—Ü—ã `payment_methods`, `subscriptions_v2`, `provider_subscriptions`
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ MIT-—Ç–æ–∫–µ–Ω—ã –∏ –∫–∞—Ä—Ç—ã
- –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É" –∏ `handleAddCard`
- –¢–∏–ø `PaymentFlowType` –∏ state (–æ—Å—Ç–∞—é—Ç—Å—è –≤ –∫–æ–¥–µ)

---

## DoD

1. PaymentDialog: –Ω–µ—Ç RadioGroup; –ø–æ–¥–ø–∏—Å–∫–∏ ‚Üí SBS; direct-charge –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è; shouldUseMitTokenization=false
2. PaymentMethods: –Ω–µ—Ç MIT-–∞–ª–µ—Ä—Ç–æ–≤; –∫–Ω–æ–ø–∫–∞ "–ü—Ä–∏–≤—è–∑–∞—Ç—å" —Ä–∞–±–æ—Ç–∞–µ—Ç; 3DS –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π
3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –Ω–µ—Ç "–ø—Ä–∏–≤—è–∂–∏—Ç–µ –∫–∞—Ä—Ç—É"; !SBS ‚Üí redirect_url –∏–∑ shared helper; SBS ‚Üí –º—è–≥–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
4. –ê–¥–º–∏–Ω–∫–∞: admin-create-payment-link —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (—Ä–µ–≥—Ä–µ—Å—Å-–ø—Ä—É—Ñ)
5. –ö–ª—é—á–∏: secret_key –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω; –ø—É—Å—Ç–æ–µ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç
6. –†–µ–≥—Ä–µ—Å—Å–∏—è: —Ä–∞–∑–æ–≤—ã–µ, –ø—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç, SBS, MIT-–ø–æ–¥–ø–∏—Å–∫–∏ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
