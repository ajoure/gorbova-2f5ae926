
# Проблема: мастер контента не позволяет добавить новый модуль в существующий тренинг ("Закрой год")

## Диагностика — что именно не работает

### Суть жалобы пользователя (скриншот)

Пользователь (@fs_by) не понимает как через мастер контента создать **подмодули** (под-тренинги) внутри существующего тренинга. Вместо этого мастер создаёт только уроки. Конкретная ситуация: "Закрой год 2025-2026" размещён в разделе **"Обучение / Моя библиотека"** (`products-library`), и при открытии мастера — недоступна возможность создать **новый модуль** в этом тренинге.

### Корневая причина — архитектурное ограничение

Текущая архитектура `training_modules`:
```text
training_modules (модуль = тренинг)
    └── training_lessons (уроки)
```

В базе данных **нет уровня "подмодуль"**. Модуль — это верхний уровень, уроки — второй уровень. Вложенных модулей (модуль внутри модуля) **не существует как концепции**.

Модуль "Закрой год 2025-2026" в БД:
- `id: 682d241e-...`
- `menu_section_key: products-library`
- `is_container: false`
- 3 урока

### Почему мастер не предлагает создать модуль внутри тренинга

Страница `/admin/training-modules/{moduleId}/lessons` (AdminTrainingLessons) — это **страница уроков конкретного модуля**. Она имеет только одну кнопку: **"+ Добавить урок"**. Кнопки "Добавить модуль" нет, и это логично — модули и так находятся на одном уровне (нет иерархии).

### Как мастер (ContentCreationWizard) работает сейчас

В мастере есть **два флоу**:
1. **MODULE flow** — создаёт новый модуль + первый урок → шаги: Раздел → Тип → Модуль → Урок → Доступ → Готово
2. **LESSON flow** — создаёт урок → шаги: Раздел → Тип → Модуль (выбор) → Доступ → Урок → Готово

На шаге "Модуль" (шаг 3 в LESSON flow) компонент `ModuleSelector` показывает **существующие модули секции** + кнопку "Создать новый модуль". Но:

**ПРОБЛЕМА**: `ModuleSelector` фильтрует по `menu_section_key = sectionKey` и `is_container = false`. Модуль "Закрой год" имеет `menu_section_key = products-library`. Если пользователь выбрал секцию `products-library` в мастере — "Закрой год" **должен отображаться** в списке для добавления урока.

### Фактическая проблема из скриншота

Пользователь хочет создать **несколько подмодулей** внутри тренинга ("Закрой год") — например:
- "Закрой год > Модуль 1: Инвентаризация"
- "Закрой год > Модуль 2: Баланс"

Но в текущей архитектуре это **невозможно** — у `training_modules` нет поля `parent_module_id`. Это не баг UI — это отсутствующая функциональность.

**Второй вопрос в скриншоте**: "Если закрой год поместила в библиотеку, почему не могу создать новый модуль в курсе закрой год?" — это уже другой вопрос: пользователь хочет, находясь на странице уроков "Закрой год", нажать кнопку и **создать ещё один модуль на том же уровне** (то есть создать ещё один тренинг в том же разделе), а не только добавлять уроки.

---

## Что делаем (минимальный diff, без ломки архитектуры)

### Решение: добавить кнопку "+ Добавить модуль" на страницу AdminTrainingLessons

Самое простое решение, которое решает реальную боль пользователя: на странице управления уроками модуля (`AdminTrainingLessons`) — рядом с кнопкой "+ Добавить урок" добавить кнопку **"+ Добавить модуль"**, которая открывает **ContentCreationWizard** с предустановленным `initialSectionKey` текущего модуля.

Тогда пользователь, находясь внутри "Закрой год", может нажать "+ Добавить модуль" → откроется мастер → сразу на шаге 2 (тип) с предустановленной секцией `products-library` → создаст новый тренинг в том же разделе.

### Изменение 1: AdminTrainingLessons.tsx

Добавить:
1. `import ContentCreationWizard` (уже не импортирован)
2. State: `const [isWizardOpen, setIsWizardOpen] = useState(false);`
3. В header рядом с кнопкой "+ Добавить урок":
```tsx
<Button variant="outline" onClick={() => setIsWizardOpen(true)}>
  <Layers className="mr-2 h-4 w-4" />
  <span className="hidden sm:inline">Добавить модуль</span>
</Button>
```
4. В конце компонента добавить:
```tsx
<ContentCreationWizard
  open={isWizardOpen}
  onOpenChange={setIsWizardOpen}
  initialSectionKey={module?.menu_section_key || "products-library"}
/>
```

### Изменение 2: ContentCreationWizard — при передаче initialSectionKey предустановить contentType="module"

Сейчас `createInitialState` по умолчанию устанавливает `contentType: "module"`. Это уже правильно. Но можно улучшить: если мастер открыт через кнопку "Добавить модуль" — пропустить шаг 1 (выбор типа) и сразу показать шаг "Модуль".

**Но это усложняет логику мастера** — не делаем это (add-only принцип).

### Изменение 3: ModuleSelector — показывать модуль "Закрой год" в списке при добавлении урока

Сейчас при lesson flow + секция `products-library` → ModuleSelector запрашивает:
```sql
WHERE menu_section_key = 'products-library' AND is_container = false AND is_active = true
```

Модуль "Закрой год" имеет `is_active = false` (из БД: `is_active:false`). Поэтому он **не отображается** в списке доступных модулей для добавления урока!

**Исправление**: убрать фильтр `is_active = true` в ModuleSelector, чтобы показывать все модули секции (включая неактивные) — или показывать их с пометкой "неактивен".

Либо **не менять ModuleSelector** — активация модуля делается отдельно.

---

## Итого: что изменяем

### Файл 1: `src/pages/admin/AdminTrainingLessons.tsx`

- Добавить импорт `ContentCreationWizard` и иконку `Layers`
- Добавить state `isWizardOpen`
- Добавить кнопку "Добавить модуль" в header рядом с "Добавить урок"
- Добавить рендер `<ContentCreationWizard ...>`

### Файл 2: `src/components/admin/trainings/ModuleSelector.tsx`

- Убрать фильтр `.eq("is_active", true)` — показывать все модули секции (включая неактивные), с бейджем "Скрыт" для неактивных модулей
- Это позволит видеть "Закрой год" (который `is_active=false`) при добавлении урока

---

## Что НЕ делаем

- Не добавляем `parent_module_id` в `training_modules` — это архитектурное изменение вне скоупа
- Не рефакторим ContentCreationWizard
- Не трогаем AdminTrainingModules.tsx
- Не трогаем схему БД

---

## DoD

**A)** На странице `/admin/training-modules/{id}/lessons` (например, Закрой год) — видна кнопка "Добавить модуль"

**B)** Нажатие на "Добавить модуль" открывает ContentCreationWizard с предустановленной секцией (той же, что у текущего модуля)

**C)** В ModuleSelector при добавлении урока в секцию `products-library` — отображается "Закрой год 2025-2026" (даже если `is_active=false`), с визуальным индикатором "Скрыт"

**D)** Скрин: кнопка видна в UI, мастер открывается
