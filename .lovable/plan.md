

# План: Новый тип блока "Опросник/Самодиагностика" (quiz_survey)

## Проблема

Текущий `quiz_single` имеет логику "правильно/неправильно" с:
- Кнопкой "Проверить ответ" на каждом вопросе
- Красной/зелёной подсветкой ответов
- Обязательным `isCorrect` у каждого варианта

Для теста самодиагностики нужна **другая логика**:
- Нет правильных/неправильных ответов
- Выбор свободный, можно менять
- Одна кнопка "Подсчитать результат" в конце всего теста
- Автоматический подсчёт категорий (А, Б, В)
- Результаты скрыты до нажатия кнопки

---

## Решение: Новый тип блока `quiz_survey`

### Структура данных

```typescript
interface SurveyQuestion {
  id: string;
  question: string;  // "1️⃣ Источник дохода\n\nОткуда формируется доход?"
  options: Array<{
    id: string;
    text: string;      // "А. Фиксированная зарплата..."
    category: string;  // "A", "B", "C" — для подсчёта
  }>;
}

interface SurveyResult {
  category: string;     // "A"
  title: string;        // "Бухгалтер-исполнитель"
  description: string;  // "Вы работаете по найму..."
  color?: string;       // "blue", "amber", "green"
}

interface SurveyMixedResult {
  categories: string[];  // ["A", "B"]
  title: string;         // "Найм с элементами фриланса"
  description: string;
}

interface QuizSurveyContent {
  title?: string;          // Заголовок теста
  instruction?: string;    // Инструкция для участника
  questions: SurveyQuestion[];
  results: SurveyResult[];
  mixedResults?: SurveyMixedResult[];
  buttonText?: string;     // "Узнать результат"
}
```

---

### UI компонента (Student View)

```text
┌─────────────────────────────────────────────────────────────────┐
│ 📋 В какой роли вы находитесь сейчас                           │
├─────────────────────────────────────────────────────────────────┤
│ ℹ️ Инструкция для участника                                    │
│ В каждом вопросе выберите ОДИН ответ...                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 1️⃣ Источник дохода                                             │
│ Откуда фактически формируется ваш доход?                       │
│                                                                 │
│   ○ А. Фиксированная зарплата...                               │
│   ● Б. Оплата напрямую от клиентов...     ← выбран             │
│   ○ В. Пакеты услуг / бизнес-модель...                         │
│                                                                 │
│ 2️⃣ Формирование цены                                           │
│   ○ А. Цена назначается не мной...                             │
│   ● Б. Ориентируюсь на рынок...           ← выбран             │
│   ○ В. Цена от ответственности...                              │
│                                                                 │
│ ... (ещё 6 вопросов) ...                                       │
│                                                                 │
│ ┌─────────────────────────────────────────────────────────────┐│
│ │        [ 🔍 Узнать результат ]  (disabled если не все)      ││
│ └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│ ═══════════════════════════════════════════════════════════════│
│ ПОСЛЕ НАЖАТИЯ:                                                  │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ 🎯 Ваш результат                                          │  │
│ │                                                           │  │
│ │ А: ██░░░░░░░░ 2                                          │  │
│ │ Б: ████████░░ 5                                          │  │
│ │ В: ██░░░░░░░░ 1                                          │  │
│ │                                                           │  │
│ │ 📊 Преобладают ответы Б                                   │  │
│ │                                                           │  │
│ │ ┌───────────────────────────────────────────────────────┐│  │
│ │ │ 💼 Бухгалтер-фрилансер                                ││  │
│ │ │                                                       ││  │
│ │ │ Вы работаете напрямую с клиентами, но...              ││  │
│ │ └───────────────────────────────────────────────────────┘│  │
│ │                                                           │  │
│ │ [ 🔄 Пройти ещё раз ]                                     │  │
│ └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Технический план

### PATCH-1: Создать `QuizSurveyBlock.tsx`

**Путь**: `src/components/admin/lesson-editor/blocks/QuizSurveyBlock.tsx`

**Функциональность**:

**Editor Mode (isEditing=true)**:
- Редактирование заголовка и инструкции
- Добавление/удаление вопросов
- Для каждого вопроса: текст вопроса + варианты с категориями
- Секция "Результаты": описания для каждой категории
- Секция "Смешанные результаты": что показать при равных ответах

**Student Mode (isEditing=false)**:
- Состояние `answers: Record<questionId, optionId>`
- Состояние `isCompleted: boolean`
- Вопросы можно свободно заполнять и менять
- Кнопка "Узнать результат" активна только когда все вопросы отвечены
- После нажатия:
  - Подсчёт категорий: `{ A: 2, B: 5, C: 1 }`
  - Определение преобладающей категории
  - Показ соответствующего результата
  - Если равные — показ смешанного результата
- Кнопка "Пройти ещё раз" сбрасывает ответы

**Дизайн (glassmorphism)**:
- `bg-card/30 backdrop-blur-xl`
- `border-border/30`
- Плавные переходы при выборе
- Результат появляется с анимацией fade-in
- Прогресс-бары для категорий

---

### PATCH-2: Зарегистрировать блок в системе

**Файлы для обновления**:

1. `src/hooks/useLessonBlocks.ts` — добавить `quiz_survey` в `BlockType`
2. `src/components/admin/lesson-editor/LessonBlockEditor.tsx`:
   - Импорт `QuizSurveyBlock`
   - Добавить в `blockTypeConfig`
   - Добавить в `availableBlocks`
   - Добавить в `getDefaultContent`
   - Добавить в `renderBlockContent`
3. `src/components/lesson/LessonBlockRenderer.tsx`:
   - Импорт `QuizSurveyBlock`
   - Добавить case в `renderBlock`

---

### PATCH-3: Миграция существующих блоков теста

После создания компонента — конвертировать данные теста:

```sql
-- Удалить старые quiz_single блоки
DELETE FROM lesson_blocks 
WHERE lesson_id = '96c970e6-d530-473c-84ab-06b176d1c98a'
AND block_type = 'quiz_single';

-- Удалить старые callout блоки с результатами
DELETE FROM lesson_blocks 
WHERE lesson_id = '96c970e6-d530-473c-84ab-06b176d1c98a'
AND sort_order >= 10;  -- результаты были с 10+

-- Вставить новый quiz_survey блок со всем контентом
INSERT INTO lesson_blocks (lesson_id, block_type, content, sort_order)
VALUES (
  '96c970e6-d530-473c-84ab-06b176d1c98a',
  'quiz_survey',
  '{...полный контент теста...}',
  2
);
```

---

## Структура контента для текущего теста

```json
{
  "title": "В какой роли вы находитесь сейчас",
  "instruction": "В каждом вопросе выберите <strong>ОДИН ответ</strong>, который наиболее точно описывает вашу <strong>текущую реальность</strong>...",
  "questions": [
    {
      "id": "q1",
      "question": "1️⃣ Источник дохода\n\nОткуда фактически формируется ваш основной доход?",
      "options": [
        { "id": "1a", "text": "А. Я получаю фиксированную зарплату или оплату за функции / участок работы.", "category": "A" },
        { "id": "1b", "text": "Б. Я получаю оплату напрямую от клиентов за ведение их учёта / отчётности.", "category": "B" },
        { "id": "1c", "text": "В. Мой доход формируется из пакетов услуг / абонентского обслуживания / бизнес-модели.", "category": "C" }
      ]
    },
    // ... ещё 7 вопросов
  ],
  "results": [
    { "category": "A", "title": "Бухгалтер-исполнитель", "description": "Вы работаете по найму или на конкретном участке работы.", "color": "blue" },
    { "category": "B", "title": "Бухгалтер-фрилансер", "description": "Вы работаете напрямую с клиентами, но часто реагируете на обстоятельства.", "color": "amber" },
    { "category": "C", "title": "Бухгалтер-предприниматель", "description": "Вы выстроили систему и бизнес-модель.", "color": "green" }
  ],
  "mixedResults": [
    { "categories": ["A", "B"], "title": "Найм с элементами фриланса", "description": "Вы находитесь между ролями исполнителя и фрилансера." },
    { "categories": ["B", "C"], "title": "Переходная стадия", "description": "Самая уязвимая и самая перспективная позиция. Вы на пути к предпринимательству." }
  ],
  "buttonText": "Узнать результат"
}
```

---

## Грамматические исправления

При создании блока исправлю замеченные проблемы:
- "учёта / отчётности" → "учёта/отчётности" (без пробелов)
- Нумерация emoji остаётся как есть (1️⃣, 2️⃣ и т.д.)
- Удалю "isCorrect" — здесь нет правильных ответов

---

## Файлы к созданию/изменению

| Файл | Действие |
|------|----------|
| `src/components/admin/lesson-editor/blocks/QuizSurveyBlock.tsx` | **Создать** |
| `src/hooks/useLessonBlocks.ts` | Добавить `quiz_survey` в BlockType |
| `src/components/admin/lesson-editor/LessonBlockEditor.tsx` | Регистрация блока |
| `src/components/lesson/LessonBlockRenderer.tsx` | Рендеринг для студентов |
| `lesson_blocks` (БД) | Миграция данных теста |

---

## DoD (Definition of Done)

| # | Проверка | Ожидание |
|---|----------|----------|
| 1 | Добавить блок "Опросник" через редактор | Блок появляется в категории "Тесты" |
| 2 | Настроить вопросы и результаты | Редактор позволяет добавлять вопросы с категориями |
| 3 | Пройти тест как пользователь | Можно выбирать ответы, менять их свободно |
| 4 | Нажать "Узнать результат" | Подсчёт категорий, показ нужного результата |
| 5 | Нажать "Пройти ещё раз" | Сброс ответов, результат скрывается |
| 6 | Проверить glassmorphism-дизайн | Прозрачность, blur, плавные анимации |

---

## Безопасность и ограничения

- Никаких изменений RLS/RBAC
- Add-only: новый компонент, минимальные изменения в существующих файлах
- Прогресс пользователя сохраняется в `user_lesson_progress` (опционально)
- Все тексты на русском языке

