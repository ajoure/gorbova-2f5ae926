План: 
# План: Глобальный iOS Safari Guard для lovable.dev + Excel-парсер (память) — фикс регресса

## Диагноз проблемы

Текущие iOS guards закрывают только маршрутизацию:
1) **saveLastRoute** — не сохраняем тяжёлые маршруты на iOS
2) **Auth restore** — не восстанавливаем тяжёлые маршруты на iOS

Но по факту у вас два источника краша iOS в lovable.dev (preview):
### A) URL-синхронизация lovable.dev → мгновенный рендер /admin/*
- На десктопе открыт `/admin/...`
- lovable.dev синхронизирует URL в iframe-превью
- iPhone получает `/admin/...` и начинает рендер тяжёлой страницы **до того, как guard успевает “спасти”**

### B) Excel-парсер (реальный триггер по вашей истории)
- После добавления/правок Excel-парсера всё становится плохо именно в lovable.dev на iOS
- Значит есть сценарий, где парсер:
  - подтягивается в общий бандл (или импортируется на старте),
  - или выполняется в превью (даже без явного захода в импорт),
  - или держит большие структуры в памяти (workbook/arrays) и не освобождает их.
- Вчера “стало хорошо” после точечного изменения — значит нужен **жёсткий запрет загрузки/инициализации Excel-логики на iOS в preview**, плюс правильная ленивость и очистка.

Цель:  
**1) Никогда не рендерить /admin/* в lovable.dev на iOS**  
**2) Никогда не загружать/выполнять Excel-парсер в lovable.dev preview на iOS**  
(даже если вы работали с импортом на десктопе и URL/состояния подтянулись в preview)

---

## Решение (порядок важен)

### 1) Глобальный guard в App.tsx — ДО Routes (как вы описали, подтверждаю)

#### 1.1. Новый хук `useIOSAdminGuard` (add-only)

Файл:
- Новый: `src/hooks/useIOSAdminGuard.ts`

Логика:
- Если **iOS Safari** AND (**iframe** OR lovable-preview flag) AND pathname startsWith `/admin`
  → немедленно redirect `/dashboard` (replace)
  → overwrite lastRoute `/dashboard`

Важно:
- Проверка должна отработать **максимально рано**, до lazy-страниц админки.

#### 1.2. Внедрение в `src/App.tsx`

- Обёртка `IOSAdminGuard` размещается **внутри BrowserRouter**, но **до** Routes.
- Guard должен срабатывать при любом pathname change.

---

### 2) Excel-парсер: запрет на iOS preview + правильный lazy-load + агрессивная очистка

Это ключевой слой, потому что именно Excel снова ломает iOS после правок.

#### 2.1. Полный запрет Excel-импорта на iOS в lovable.dev preview

Файлы (примерно, по месту где импорт/парсер):
- `src/pages/admin/AdminKbImport.tsx` (или ваш экран импорта)
- `src/lib/excel/*` (где парсер)
- (если есть) `src/hooks/useExcelParser.ts`

Изменения:
- В точке входа на страницу импорта:
  - если `isIOSSafari() && isInIframePreview()`:
    - **не рендерить импорт**
    - показывать компактную заглушку:
      - “Импорт Excel недоступен в предпросмотре lovable.dev на iOS. Откройте на десктопе.”
    - никаких dynamic imports парсера
    - никаких запросов/подготовок данных

DoD-Excel-0:
- В lovable.dev preview на iOS **нельзя попасть в импорт**, и парсер не загружается вообще.

#### 2.2. Жёсткий lazy-load Excel-библиотеки (чтобы она не попадала в стартовый бандл)

Проблема, которую надо исключить:
- `import * as XLSX from 'xlsx'` или аналог на верхнем уровне файла
- или общий `index.ts` который подтягивается всегда

Правка:
- Перенести импорт XLSX внутрь обработчика:
  - `const XLSX = await import('xlsx');`
- Никогда не импортировать парсер “на модульном уровне” (top-level import).

DoD-Excel-1:
- До нажатия кнопки “Загрузить/Парсить Excel” XLSX не загружается.

#### 2.3. Очистка памяти после парсинга (обязательная)

После парсинга:
- обнуляем большие объекты:
  - `workbook = null`
  - `rows = null`
  - `sheet = null`
  - `arrayBuffer = null`
- если используете `FileReader`:
  - `reader.onload = null; reader.onerror = null;`
- если держите результаты в state:
  - хранить только минимально нужные поля
  - не хранить исходный raw-sheet/json целиком, если не нужно
- после завершения:
  - `await new Promise(requestAnimationFrame)` (дать GC шанс)
  - опционально: chunk processing вместо одного giant массива

DoD-Excel-2:
- Повторный импорт не увеличивает память “ступенькой” и не приводит к деградации preview.

#### 2.4. Предохранитель: не выполнять парсинг автоматически

Запрещаем любые авто-триггеры:
- никаких `useEffect(() => parse(fileFromState), ...)`
- парсинг только по явному клику пользователя в админке на десктопе

DoD-Excel-3:
- При открытии админ-импорта ничего не парсится без клика.

---

### 3) Обновление BUILD_MARKER (обязательная верификация)

Файл:
- `src/lib/externalLinkKillSwitch.ts`

Изменить:
- `BUILD_MARKER = "build: 2026-01-30T... ios-admin-guard+excel-hard-stop-v6"`

---

## Как проверяем (строго по DoD)

### A) Desktop (контроль)
1) Открыть `/admin/kb-import`
2) Импорт Excel работает как раньше
3) Логин/lastRoute работает как раньше

### B) iPhone в lovable.dev (главная проверка)
1) Открыть lovable.dev → проект
2) Не падает/не перезагружается
3) Если URL подтянул `/admin/*` → мгновенно переводит на `/dashboard`
4) Даже если попытаться открыть импорт:
   - видим заглушку
   - парсер не грузится

### C) Контроль “Excel не тянется в старт”
1) В preview на iOS открыть консоль/логи
2) Убедиться, что нет следов загрузки XLSX (по логам/маркеру/размеру бандла)

---

## Почему это сработает

- Глобальный guard убирает сценарий “URL пришёл /admin → тяжёлый рендер → краш”.
- Excel hard-stop убирает главный источник регресса: парсер больше не может подтягиваться/исполняться в iOS preview.
- Lazy-load + очистка памяти делают поведение стабильным на десктопе и в проде.

---

## Файлы для изменения

| Файл | Изменения |
|------|-----------|
| Новый: `src/hooks/useIOSAdminGuard.ts` | Глобальный iOS admin guard для iframe/preview |
| `src/App.tsx` | Подключить IOSAdminGuard до Routes |
| `src/pages/admin/AdminKbImport.tsx` (или экран импорта) | iOS preview hard-stop + заглушка |
| Файлы Excel-парсера (`src/lib/excel/*` или где он у вас) | убрать top-level XLSX import, сделать dynamic import, очистку памяти, запрет автопарса |
| `src/lib/externalLinkKillSwitch.ts` | обновить BUILD_MARKER |

---

## Критерии готовности

1) lovable.dev на iPhone **перестаёт падать** при открытии проекта  
2) `/admin/*` **никогда не рендерится** в preview на iOS (мгновенный redirect)  
3) Excel-парсер **не загружается и не выполняется** в lovable.dev preview на iOS  
4) Desktop поведение не сломано: импорт Excel работает  
5) BUILD_MARKER обновлён и виден (v6)

---

## Риски

- В lovable.dev preview на iOS импорт Excel будет недоступен (это осознанно).
- В production (club.gorbova.by) ничего не меняется, потому что условие только для iframe/preview.