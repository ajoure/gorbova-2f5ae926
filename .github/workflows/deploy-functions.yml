name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - main
    # REMOVED: paths restriction - deploy functions on EVERY push to main
    # This ensures functions are always deployed after publish
  workflow_dispatch:

# PATCH: Prevent parallel deploys (cancel old if new starts)
concurrency:
  group: edge-functions-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff comparison

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate Project Reference
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          EXPECTED_PROJECT_REF: hdjgkjceownmmnrqqtuz
        run: |
          # Extract PROJECT_REF from SUPABASE_URL dynamically
          DERIVED_REF=$(echo "$SUPABASE_URL" | sed -E 's#https://([^.]+)\..*#\1#')
          
          echo "========================================"
          echo "PROJECT REFERENCE VALIDATION"
          echo "========================================"
          echo "SUPABASE_URL: $SUPABASE_URL"
          echo "DERIVED_REF: $DERIVED_REF"
          echo "EXPECTED_REF: $EXPECTED_PROJECT_REF"
          echo "GITHUB_SHA: ${{ github.sha }}"
          echo "GITHUB_RUN_ID: ${{ github.run_id }}"
          echo "GITHUB_RUN_NUMBER: ${{ github.run_number }}"
          echo "========================================"
          
          if [ "$DERIVED_REF" != "$EXPECTED_PROJECT_REF" ]; then
            echo "::error::Wrong project ref! Expected $EXPECTED_PROJECT_REF, got $DERIVED_REF"
            exit 1
          fi
          
          echo "✅ Project reference validated successfully"

      - name: Lint Guards - Prevent Known Issues
        run: |
          echo "========================================"
          echo "LINT GUARDS — Pre-deployment validation"
          echo "========================================"
          
          ERRORS=0
          
          # 1. Block esm.sh imports (causes cold-start issues)
          echo "Checking for esm.sh imports..."
          if grep -RIn "https://esm\.sh/" supabase/functions --include="*.ts"; then
            echo "::error::Found esm.sh imports - use npm: specifier instead"
            ERRORS=1
          else
            echo "✅ No esm.sh imports found"
          fi
          
          # 2. Block serve() usage (must use Deno.serve)
          echo "Checking for deprecated serve() usage..."
          if grep -RIn "([^A-Za-z0-9_]|^)serve\(" supabase/functions --include="*.ts" | grep -v "Deno\.serve"; then
            echo "::error::Found serve() usage - use Deno.serve() instead"
            ERRORS=1
          else
            echo "✅ No deprecated serve() usage found"
          fi
          
          # 3. Warn on functions without OPTIONS handler (browser functions need this)
          echo "Checking for OPTIONS handlers..."
          MISSING_OPTIONS=0
          for d in supabase/functions/*/; do
            f="${d}index.ts"
            [ -f "$f" ] || continue
            if ! grep -q "OPTIONS" "$f"; then
              func_name=$(basename "$d")
              echo "::warning::No OPTIONS handling found in $func_name"
              MISSING_OPTIONS=$((MISSING_OPTIONS + 1))
            fi
          done
          if [ "$MISSING_OPTIONS" -gt 0 ]; then
            echo "⚠️ $MISSING_OPTIONS functions without OPTIONS handler"
          else
            echo "✅ All functions have OPTIONS handlers"
          fi
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Lint guards failed! Fix the issues above before deploying."
            exit 1
          fi
          
          echo "✅ All lint guards passed"

      - name: Validate Registry File
        run: |
          REGISTRY_FILE="supabase/functions.registry.txt"
          
          if [ ! -f "$REGISTRY_FILE" ]; then
            echo "::error::Registry file not found: $REGISTRY_FILE"
            exit 1
          fi
          
          echo "Validating registry file format..."
          BAD=0
          LINE_NUM=0
          while IFS= read -r line || [ -n "$line" ]; do
            LINE_NUM=$((LINE_NUM + 1))
            line="$(echo "$line" | tr -d '\r' | xargs)"
            
            # Skip empty lines and comments
            [[ -z "$line" || "$line" =~ ^#.* ]] && continue
            
            # Validate function name format: lowercase letters, numbers, hyphens only
            if [[ ! "$line" =~ ^[a-z0-9-]+$ ]]; then
              echo "::error::Line $LINE_NUM: Invalid function name format: '$line'"
              BAD=1
            fi
            
            # Check if function directory exists
            if [ ! -d "supabase/functions/$line" ]; then
              echo "::error::Line $LINE_NUM: Function directory not found: supabase/functions/$line"
              BAD=1
            fi
          done < "$REGISTRY_FILE"
          
          if [ "$BAD" = "1" ]; then
            echo "::error::Registry validation failed!"
            exit 1
          fi
          
          # Count functions
          FUNC_COUNT=$(grep -vE '^\s*(#|$)' "$REGISTRY_FILE" | wc -l | xargs)
          echo "✅ Registry validated: $FUNC_COUNT functions"

      - name: Deploy Edge Functions (Registry-Driven)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase link --project-ref hdjgkjceownmmnrqqtuz
          
          REGISTRY_FILE="supabase/functions.registry.txt"
          
          echo "========================================"
          echo "DEPLOYMENT STRATEGY: Registry-driven deploy"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "========================================"
          
          # Read functions from registry
          mapfile -t FUNCS < <(grep -vE '^\s*(#|$)' "$REGISTRY_FILE" | tr -d '\r' | xargs -n1)
          
          TOTAL=${#FUNCS[@]}
          echo "Deploying from registry: $TOTAL functions"
          echo ""
          
          DEPLOYED_COUNT=0
          FAILED_COUNT=0
          
          for i in "${!FUNCS[@]}"; do
            func="${FUNCS[$i]}"
            idx=$((i + 1))
            
            echo ""
            echo "--- [$idx/$TOTAL] Deploying: $func ---"
            if supabase functions deploy "$func"; then
              echo "✅ Deployed: $func"
              DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
            else
              echo "❌ FAILED to deploy: $func"
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
          done
          
          echo ""
          echo "========================================"
          echo "DEPLOYMENT SUMMARY"
          echo "========================================"
          echo "✅ Deployed: $DEPLOYED_COUNT / $TOTAL"
          echo "❌ Failed: $FAILED_COUNT"
          echo "========================================"
          
          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "::error::$FAILED_COUNT functions failed to deploy!"
            exit 1
          fi

      - name: Smoke Checks - Critical Functions
        env:
          SUPABASE_URL: https://hdjgkjceownmmnrqqtuz.supabase.co
        run: |
          # ============================================
          # SMOKE CHECKS: Verify critical functions are reachable
          # ============================================
          echo ""
          echo "Running smoke checks for critical functions..."
          
          SMOKE_LOG="smoke-checks-$(date -u +%Y%m%d-%H%M%S).log"
          echo "=== SMOKE CHECK STARTED $(date -u '+%Y-%m-%d %H:%M:%S UTC') ===" > "$SMOKE_LOG"
          
          # P0: Must-exist functions (business critical)
          CRITICAL_FUNCTIONS=(
            "payment-method-verify-recurring"
            "bepaid-list-subscriptions"
            "bepaid-get-subscription-details"
            "bepaid-create-token"
            "admin-payments-diagnostics"
            "integration-healthcheck"
            "nightly-system-health"
            "nightly-payments-invariants"
            "public-product"
            "telegram-webhook"
            "users-admin-actions"
          )
          
          SMOKE_FAILED=0
          
          for func in "${CRITICAL_FUNCTIONS[@]}"; do
            echo "" | tee -a "$SMOKE_LOG"
            echo "=== Smoke check: $func ===" | tee -a "$SMOKE_LOG"
            
            # POST existence check with timeout
            POST_RESPONSE=$(curl -s -w "\n%{http_code}" -m 15 \
              -X POST \
              -H "Content-Type: application/json" \
              -d '{"ping":true}' \
              "$SUPABASE_URL/functions/v1/$func" 2>&1)
            
            POST_STATUS=$(echo "$POST_RESPONSE" | tail -1)
            POST_BODY=$(echo "$POST_RESPONSE" | sed '$d')
            
            echo "HTTP Status: $POST_STATUS" | tee -a "$SMOKE_LOG"
            echo "Response: $POST_BODY" | tee -a "$SMOKE_LOG"
            
            if [ "$POST_STATUS" = "404" ]; then
              echo "❌ FAIL: $func returned 404 NOT_FOUND" | tee -a "$SMOKE_LOG"
              SMOKE_FAILED=1
            elif [ "$POST_STATUS" = "000" ]; then
              echo "❌ FAIL: $func - connection failed (timeout)" | tee -a "$SMOKE_LOG"
              SMOKE_FAILED=1
            elif echo "$POST_BODY" | grep -q '"code":"NOT_FOUND"'; then
              echo "❌ FAIL: $func returned NOT_FOUND in body" | tee -a "$SMOKE_LOG"
              SMOKE_FAILED=1
            else
              # 200, 400, 401, 403 = function exists and responds
              echo "✅ OK: $func returned HTTP $POST_STATUS (function exists)" | tee -a "$SMOKE_LOG"
            fi
          done
          
          echo "" | tee -a "$SMOKE_LOG"
          echo "=== SMOKE CHECK COMPLETED $(date -u '+%Y-%m-%d %H:%M:%S UTC') ===" | tee -a "$SMOKE_LOG"
          
          # Save log path for artifact upload
          echo "SMOKE_LOG=$SMOKE_LOG" >> $GITHUB_ENV
          
          if [ "$SMOKE_FAILED" = "1" ]; then
            echo "::error::Smoke checks failed! One or more critical functions are not reachable."
            exit 1
          fi
          
          echo "✅ All smoke checks passed!"

      - name: Canary Verify - CORS Preflight
        env:
          SUPABASE_URL: https://hdjgkjceownmmnrqqtuz.supabase.co
          ORIGIN: https://gorbova.lovable.app
        run: |
          # ============================================
          # CANARY VERIFY: OPTIONS preflight for UI functions
          # ============================================
          echo ""
          echo "Running CORS preflight canary checks..."
          
          VERIFY_LOG="verify-cors-$(date -u +%Y%m%d-%H%M%S).log"
          echo "=== CORS VERIFY STARTED $(date -u '+%Y-%m-%d %H:%M:%S UTC') ===" > "$VERIFY_LOG"
          
          CORS_FUNCTIONS=("public-product" "bepaid-create-token")
          CORS_FAILED=0
          
          for func in "${CORS_FUNCTIONS[@]}"; do
            echo "" | tee -a "$VERIFY_LOG"
            echo "=== OPTIONS preflight: $func ===" | tee -a "$VERIFY_LOG"
            
            OPTIONS_RESPONSE=$(curl -s -i -m 10 -X OPTIONS \
              -H "Origin: $ORIGIN" \
              -H "Access-Control-Request-Method: POST" \
              -H "Access-Control-Request-Headers: content-type,authorization,x-supabase-client-platform" \
              "$SUPABASE_URL/functions/v1/$func" 2>&1)
            
            echo "$OPTIONS_RESPONSE" >> "$VERIFY_LOG"
            
            # Check for required CORS headers
            if echo "$OPTIONS_RESPONSE" | grep -qi "access-control-allow-headers.*x-supabase-client"; then
              echo "✅ CORS OK: $func has x-supabase-client-* headers" | tee -a "$VERIFY_LOG"
            else
              echo "⚠️ CORS WARNING: $func may be missing x-supabase-client-* headers" | tee -a "$VERIFY_LOG"
              # Don't fail pipeline, just warn (CORS update is gradual)
            fi
            
            # Check it's not 404
            if echo "$OPTIONS_RESPONSE" | grep -q "HTTP/[0-9.]* 404"; then
              echo "❌ FAIL: $func returned 404 on OPTIONS" | tee -a "$VERIFY_LOG"
              CORS_FAILED=1
            fi
          done
          
          echo "" | tee -a "$VERIFY_LOG"
          echo "=== CORS VERIFY COMPLETED ===" | tee -a "$VERIFY_LOG"
          
          echo "VERIFY_LOG=$VERIFY_LOG" >> $GITHUB_ENV
          
          if [ "$CORS_FAILED" = "1" ]; then
            echo "::error::CORS canary failed! Critical UI functions not responding to OPTIONS."
            exit 1
          fi
          
          echo "✅ CORS canary checks passed!"

      - name: Canary Verify - Business Logic
        env:
          SUPABASE_URL: https://hdjgkjceownmmnrqqtuz.supabase.co
        run: |
          # ============================================
          # CANARY VERIFY: Business logic endpoints
          # ============================================
          echo ""
          echo "Running business logic canary checks..."
          
          CANARY_LOG="verify-canary-$(date -u +%Y%m%d-%H%M%S).log"
          echo "=== CANARY VERIFY STARTED $(date -u '+%Y-%m-%d %H:%M:%S UTC') ===" > "$CANARY_LOG"
          
          # public-product uses query param, not body (as per contract)
          echo "=== Canary: public-product (query param) ===" | tee -a "$CANARY_LOG"
          PP_RESPONSE=$(curl -s -m 20 \
            "$SUPABASE_URL/functions/v1/public-product?domain=gorbova.lovable.app" 2>&1)
          echo "$PP_RESPONSE" | head -c 500 >> "$CANARY_LOG"
          echo "" >> "$CANARY_LOG"
          
          # Check it's not a raw 404/NOT_FOUND
          if echo "$PP_RESPONSE" | grep -q '"code":"NOT_FOUND"'; then
            echo "❌ FAIL: public-product function NOT_FOUND" | tee -a "$CANARY_LOG"
            exit 1
          fi
          echo "✅ public-product responds (may be 404 product not found - that's OK)" | tee -a "$CANARY_LOG"
          
          # integration-healthcheck
          echo "" | tee -a "$CANARY_LOG"
          echo "=== Canary: integration-healthcheck ===" | tee -a "$CANARY_LOG"
          IH_RESPONSE=$(curl -s -m 20 -X POST \
            -H "Content-Type: application/json" \
            -d '{}' \
            "$SUPABASE_URL/functions/v1/integration-healthcheck" 2>&1)
          echo "$IH_RESPONSE" | head -c 500 >> "$CANARY_LOG"
          echo "" >> "$CANARY_LOG"
          
          if echo "$IH_RESPONSE" | grep -q '"code":"NOT_FOUND"'; then
            echo "❌ FAIL: integration-healthcheck NOT_FOUND" | tee -a "$CANARY_LOG"
            exit 1
          fi
          echo "✅ integration-healthcheck responds" | tee -a "$CANARY_LOG"
          
          echo "" | tee -a "$CANARY_LOG"
          echo "=== CANARY VERIFY COMPLETED ===" | tee -a "$CANARY_LOG"
          
          echo "CANARY_LOG=$CANARY_LOG" >> $GITHUB_ENV
          echo "✅ All canary checks passed!"

      - name: Upload Verification Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-verification-logs
          path: |
            smoke-checks-*.log
            verify-cors-*.log
            verify-canary-*.log
          retention-days: 7

      - name: Deployment Complete
        run: |
          echo ""
          echo "========================================"
          echo "DEPLOYMENT COMPLETE"
          echo "========================================"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Commit: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "========================================"
